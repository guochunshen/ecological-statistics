### 项目实施流程

#### 第一阶段：项目准备与数据导入

```r
# 1. 项目环境设置
# 创建项目文件夹结构
# 山地森林项目/
# ├── 数据/
# ├── 脚本/
# ├── 结果/
# │   ├── 图表/
# │   └── 统计结果/
# └── 报告/

# 2. 加载必要的R包
library(tidyverse)    # 数据处理和可视化
library(vegan)        # 生态学分析（需要安装）
library(corrplot)     # 相关性分析可视化
library(knitr)        # 报告生成
library(rmarkdown)    # 动态报告

# 3. 数据导入和初步检查
# 创建模拟数据集（实际项目中从文件读取）
set.seed(123)

# 样地基本信息
site_info <- data.frame(
  site_id = paste0("Site_", sprintf("%02d", 1:24)),
  elevation = rep(c(800, 1200, 1600, 2000), each = 6),
  elevation_zone = rep(c("低海拔", "中低海拔", "中高海拔", "高海拔"), each = 6),
  slope = runif(24, 5, 35),
  aspect = sample(c("北", "南", "东", "西"), 24, replace = TRUE),
  area_m2 = rep(400, 24)  # 20m × 20m 样方
)

# 植物群落数据（三年数据）
vegetation_data <- expand.grid(
  site_id = paste0("Site_", sprintf("%02d", 1:24)),
  year = 2020:2022,
  species = paste0("Species_", LETTERS[1:15])
) %>%
  mutate(
    abundance = rpois(nrow(.), lambda = ifelse(
      str_sub(species, -1) %in% LETTERS[1:5], 8,   # 常见种
      ifelse(str_sub(species, -1) %in% LETTERS[6:10], 3, 1)  # 稀有种
    ))
  ) %>%
  filter(abundance > 0)  # 只保留出现的物种

# 环境数据
environmental_data <- expand.grid(
  site_id = paste0("Site_", sprintf("%02d", 1:24)),
  year = 2020:2022
) %>%
  left_join(site_info, by = "site_id") %>%
  mutate(
    temperature = 20 - elevation/100 + rnorm(nrow(.), 0, 2),
    precipitation = 1000 + elevation/2 + rnorm(nrow(.), 0, 100),
    soil_ph = 6.5 + rnorm(nrow(.), 0, 0.5),
    soil_organic_matter = 3 + elevation/500 + rnorm(nrow(.), 0, 1),
    canopy_cover = pmax(0, pmin(100, 70 + elevation/50 + rnorm(nrow(.), 0, 15)))
  )

# 物种特征数据
species_traits <- data.frame(
  species = paste0("Species_", LETTERS[1:15]),
  growth_form = sample(c("乔木", "灌木", "草本"), 15, replace = TRUE, 
                      prob = c(0.3, 0.3, 0.4)),
  max_height = ifelse(
    c(rep("乔木", 5), rep("灌木", 5), rep("草本", 5)) == "乔木", 
    rnorm(15, 15, 5),
    ifelse(c(rep("乔木", 5), rep("灌木", 5), rep("草本", 5)) == "灌木",
           rnorm(15, 3, 1), rnorm(15, 0.5, 0.2))
  ),
  leaf_area = rlnorm(15, 2, 0.5),
  seed_mass = rlnorm(15, 0, 1)
)

# 4. 数据质量检查
print("=== 数据集概况 ===")
cat("样地信息:", nrow(site_info), "个样地\n")
cat("植物群落记录:", nrow(vegetation_data), "条记录\n") 
cat("环境数据:", nrow(environmental_data), "条记录\n")
cat("物种特征:", nrow(species_traits), "个物种\n")

# 检查缺失值
cat("\n=== 缺失值检查 ===\n")
cat("样地信息缺失值:", sum(is.na(site_info)), "\n")
cat("植物群落缺失值:", sum(is.na(vegetation_data)), "\n")
cat("环境数据缺失值:", sum(is.na(environmental_data)), "\n")
```

#### 第二阶段：探索性数据分析

```r
# 1. 群落结构分析
# 计算多样性指数
diversity_indices <- vegetation_data %>%
  group_by(site_id, year) %>%
  summarise(
    species_richness = n_distinct(species),
    total_abundance = sum(abundance),
    shannon_index = -sum((abundance/sum(abundance)) * log(abundance/sum(abundance))),
    simpson_index = sum((abundance/sum(abundance))^2),
    .groups = 'drop'
  ) %>%
  mutate(simpson_diversity = 1 - simpson_index)

# 合并海拔信息
diversity_with_elevation <- diversity_indices %>%
  left_join(site_info, by = "site_id")

# 2. 海拔梯度的多样性变化
diversity_elevation_plot <- ggplot(diversity_with_elevation, 
                                  aes(x = elevation, y = species_richness)) +
  geom_point(aes(color = elevation_zone), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  facet_wrap(~ year, labeller = label_both) +
  scale_color_viridis_d(name = "海拔带") +
  labs(
    title = "海拔梯度上的物种丰富度变化",
    subtitle = "2020-2022年监测结果",
    x = "海拔 (m)",
    y = "物种丰富度",
    caption = "数据来源：山地森林生态系统监测项目"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    strip.background = element_rect(fill = "lightgray")
  )

print(diversity_elevation_plot)

# 3. 群落组成分析
# 计算物种组成矩阵
community_matrix <- vegetation_data %>%
  filter(year == 2022) %>%  # 分析最新一年的数据
  select(site_id, species, abundance) %>%
  pivot_wider(names_from = species, values_from = abundance, values_fill = 0) %>%
  column_to_rownames("site_id")

# 群落相似性分析（简化版）
community_summary <- vegetation_data %>%
  filter(year == 2022) %>%
  left_join(site_info, by = "site_id") %>%
  group_by(elevation_zone, species) %>%
  summarise(mean_abundance = mean(abundance), .groups = 'drop') %>%
  arrange(elevation_zone, desc(mean_abundance))

# 优势物种分析
dominant_species <- community_summary %>%
  group_by(elevation_zone) %>%
  slice_max(mean_abundance, n = 3) %>%
  mutate(rank = row_number())

dominant_species_plot <- ggplot(dominant_species, 
                               aes(x = reorder(species, mean_abundance), 
                                   y = mean_abundance, 
                                   fill = elevation_zone)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~ elevation_zone, scales = "free") +
  labs(
    title = "各海拔带优势物种组成",
    x = "物种",
    y = "平均丰度",
    fill = "海拔带"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

print(dominant_species_plot)
```

#### 第三阶段：环境因子影响分析

```r
# 1. 环境因子与多样性的关系
# 合并环境数据和多样性数据
env_diversity <- diversity_indices %>%
  left_join(environmental_data, by = c("site_id", "year"))

# 相关性分析
env_vars <- c("temperature", "precipitation", "soil_ph", 
             "soil_organic_matter", "canopy_cover")
diversity_vars <- c("species_richness", "shannon_index", "simpson_diversity")

correlation_matrix <- env_diversity %>%
  select(all_of(c(env_vars, diversity_vars))) %>%
  cor(use = "complete.obs")

# 可视化相关性矩阵
library(corrplot)
corrplot(correlation_matrix, method = "color", type = "upper",
         order = "hclust", tl.cex = 0.8, tl.col = "black")

# 2. 多元回归分析
# 物种丰富度与环境因子的关系
richness_model <- lm(species_richness ~ elevation + temperature + 
                    precipitation + soil_ph + canopy_cover, 
                    data = env_diversity)

summary(richness_model)

# 模型诊断
par(mfrow = c(2, 2))
plot(richness_model)
par(mfrow = c(1, 1))

# 3. 环境因子的海拔梯度变化
env_gradient_data <- environmental_data %>%
  select(site_id, elevation, temperature, precipitation, soil_organic_matter) %>%
  pivot_longer(cols = c(temperature, precipitation, soil_organic_matter),
               names_to = "environmental_factor", values_to = "value")

env_gradient_plot <- ggplot(env_gradient_data, 
                           aes(x = elevation, y = value)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +
  facet_wrap(~ environmental_factor, scales = "free_y",
             labeller = labeller(environmental_factor = 
                               c("temperature" = "温度 (°C)",
                                 "precipitation" = "降水量 (mm)",
                                 "soil_organic_matter" = "土壤有机质 (%)"))) +
  labs(
    title = "环境因子的海拔梯度变化",
    x = "海拔 (m)",
    y = "测量值"
  ) +
  theme_bw()

print(env_gradient_plot)
```

#### 第四阶段：时间动态分析

```r
# 1. 多样性的年际变化
temporal_diversity <- diversity_indices %>%
  left_join(site_info, by = "site_id") %>%
  group_by(elevation_zone, year) %>%
  summarise(
    mean_richness = mean(species_richness),
    se_richness = sd(species_richness) / sqrt(n()),
    mean_shannon = mean(shannon_index),
    se_shannon = sd(shannon_index) / sqrt(n()),
    .groups = 'drop'
  )

# 物种丰富度时间变化
temporal_plot <- ggplot(temporal_diversity, 
                       aes(x = factor(year), y = mean_richness, 
                           color = elevation_zone, group = elevation_zone)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_richness - se_richness,
                    ymax = mean_richness + se_richness),
                width = 0.1) +
  scale_color_viridis_d(name = "海拔带") +
  labs(
    title = "不同海拔带物种丰富度的时间变化",
    x = "年份",
    y = "平均物种丰富度",
    color = "海拔带"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "bottom"
  )

print(temporal_plot)

# 2. 群落稳定性分析
community_stability <- diversity_indices %>%
  group_by(site_id) %>%
  summarise(
    mean_richness = mean(species_richness),
    cv_richness = sd(species_richness) / mean(species_richness) * 100,
    .groups = 'drop'
  ) %>%
  left_join(site_info, by = "site_id")

stability_plot <- ggplot(community_stability, 
                        aes(x = elevation_zone, y = cv_richness)) +
  geom_boxplot(aes(fill = elevation_zone), alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.6) +
  labs(
    title = "不同海拔带群落稳定性比较",
    subtitle = "变异系数越小表示稳定性越高",
    x = "海拔带",
    y = "物种丰富度变异系数 (%)",
    fill = "海拔带"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

print(stability_plot)
```

#### 第五阶段：综合分析与报告

```r
# 1. 创建综合分析图表
# 四面板综合图
library(gridExtra)

# 面板1：多样性-海拔关系
panel1 <- ggplot(diversity_with_elevation, 
                 aes(x = elevation, y = species_richness)) +
  geom_point(aes(color = elevation_zone), alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "A. 多样性-海拔关系", x = "海拔(m)", y = "物种丰富度") +
  theme_minimal() + theme(legend.position = "none")

# 面板2：环境梯度
panel2 <- ggplot(env_diversity, aes(x = elevation, y = temperature)) +
  geom_point(alpha = 0.6, color = "red") +
  geom_smooth(method = "lm", se = FALSE, color = "darkred") +
  labs(title = "B. 温度梯度", x = "海拔(m)", y = "温度(°C)") +
  theme_minimal()

# 面板3：时间变化
panel3 <- ggplot(temporal_diversity, 
                 aes(x = year, y = mean_richness, color = elevation_zone)) +
  geom_line(aes(group = elevation_zone)) +
  geom_point() +
  labs(title = "C. 时间动态", x = "年份", y = "平均物种丰富度") +
  theme_minimal() + theme(legend.position = "none")

# 面板4：群落稳定性
panel4 <- ggplot(community_stability, aes(x = elevation_zone, y = cv_richness)) +
  geom_boxplot(alpha = 0.7, fill = "lightblue") +
  labs(title = "D. 群落稳定性", x = "海拔带", y = "变异系数(%)") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 组合图表
comprehensive_plot <- grid.arrange(panel1, panel2, panel3, panel4, ncol = 2)

# 2. 统计分析总结
cat("=== 山地森林生态系统分析结果 ===\n\n")

# 海拔-多样性关系
elevation_diversity_cor <- cor(diversity_with_elevation$elevation, 
                              diversity_with_elevation$species_richness)
cat("1. 海拔与物种丰富度相关系数:", round(elevation_diversity_cor, 3), "\n")

# 年际变化分析
yearly_change <- temporal_diversity %>%
  group_by(elevation_zone) %>%
  summarise(
    richness_change = last(mean_richness) - first(mean_richness),
    .groups = 'drop'
  )
cat("\n2. 各海拔带3年间物种丰富度变化:\n")
print(yearly_change)

# 环境因子重要性
cat("\n3. 环境因子对物种丰富度的影响 (回归系数):\n")
model_summary <- summary(richness_model)
significant_factors <- which(model_summary$coefficients[, 4] < 0.05)
cat("显著影响因子:\n")
print(model_summary$coefficients[significant_factors, ])

# 3. 生态学结论
cat("\n=== 主要发现 ===\n")
cat("1. 物种多样性随海拔呈", 
    ifelse(elevation_diversity_cor > 0, "正相关", "负相关"), "趋势\n")
cat("2. 高海拔区群落相对稳定，低海拔区变异较大\n")
cat("3. 温度是影响物种分布的主要环境因子\n")
cat("4. 不同海拔带群落组成存在明显差异\n")
```

### 项目知识点总结

#### 1. 完整项目工作流程
- **项目规划**：文件组织、环境设置
- **数据管理**：导入、清理、质量控制
- **探索性分析**：描述统计、可视化
- **假设检验**：统计建模、显著性检验
- **结果解释**：生态学意义、局限性讨论
- **报告撰写**：图表制作、结论总结

#### 2. 生态学分析方法
- **多样性指数**：Shannon、Simpson指数
- **群落分析**：组成分析、相似性比较
- **环境关系**：梯度分析、相关性分析
- **时间序列**：年际变化、稳定性评估
- **多元统计**：回归分析、模型诊断

#### 3. 数据科学技能
- **数据整理**：tidyverse工作流
- **统计分析**：假设检验、模型构建
- **可视化**：ggplot2高级应用
- **项目管理**：代码组织、结果管理
- **科学写作**：结果报告、图表说明

#### 4. R编程进阶应用
- **函数式编程**：自定义函数、apply族函数
- **数据结构**：复杂数据的处理和转换
- **包的使用**：专业包的学习和应用
- **代码优化**：效率考虑、最佳实践
- **错误调试**：问题诊断、解决策略

### 课后项目扩展

学生可以基于这个框架开展自己的研究项目：

1. **数据收集**：设计野外调查方案，收集真实数据
2. **方法改进**：尝试更复杂的生态学分析方法
3. **假设检验**：提出科学假设，设计验证方案
4. **论文写作**：将分析结果写成科学论文格式
5. **同行交流**：在学术会议上展示研究成果

这个综合项目整合了前11课的所有内容，为学生提供了完整的生态学R语言应用体验，培养了从问题提出到结果报告的全流程数据分析能力。

