
## 第14课：假设检验基础

### 统计学背景
假设检验是统计推断的核心方法，用于判断样本数据是否支持关于总体的某种假设。在生态学研究中，我们经常需要回答这样的问题：某处理是否对植物生长有显著影响？两个栖息地的物种多样性是否存在差异？污染是否显著影响了鱼类的生存率？假设检验为这些问题提供了科学的统计判断标准。

### 演示数据
```r
# 某生态修复实验数据
set.seed(123)
# 对照组植物高度
control_heights <- rnorm(30, mean = 45, sd = 8)
# 处理组植物高度  
treatment_heights <- rnorm(30, mean = 52, sd = 8)

# 污染前后鱼类密度
before_pollution <- rpois(25, lambda = 12)
after_pollution <- rpois(25, lambda = 8)

# 某物种的生存情况
survival_data <- c(rep(1, 85), rep(0, 15))  # 85存活，15死亡
```

### 课堂演示过程

#### 1. 假设检验的基本逻辑

```r
# 假设检验的基本概念演示

# 例子：检验某种鸟类的平均筑巢高度是否为5米
set.seed(123)
nest_heights <- rnorm(25, mean = 5.8, sd = 1.2)

# 1. 建立假设
# H0: μ = 5 (零假设：平均筑巢高度为5米)
# H1: μ ≠ 5 (备择假设：平均筑巢高度不为5米)

print("=== 假设检验步骤演示 ===")
print("H0: μ = 5米")
print("H1: μ ≠ 5米")

# 2. 选择显著性水平
alpha <- 0.05
print(paste("显著性水平 α =", alpha))

# 3. 计算检验统计量
sample_mean <- mean(nest_heights)
sample_sd <- sd(nest_heights)
n <- length(nest_heights)
hypothesized_mean <- 5

# t统计量（小样本，总体方差未知）
t_statistic <- (sample_mean - hypothesized_mean) / (sample_sd / sqrt(n))

print(paste("样本均值:", round(sample_mean, 3)))
print(paste("t统计量:", round(t_statistic, 3)))

# 4. 确定临界值和拒绝域
df <- n - 1
t_critical <- qt(1 - alpha/2, df)  # 双侧检验
print(paste("临界值: ±", round(t_critical, 3)))

# 5. 计算p值
p_value <- 2 * (1 - pt(abs(t_statistic), df))  # 双侧p值
print(paste("p值:", round(p_value, 4)))

# 6. 做出统计决策
if (p_value < alpha) {
  decision <- "拒绝H0，接受H1"
  conclusion <- "有统计证据表明平均筑巢高度显著不等于5米"
} else {
  decision <- "不拒绝H0"
  conclusion <- "没有足够证据表明平均筑巢高度显著不等于5米"
}

print(paste("统计决策:", decision))
print(paste("结论:", conclusion))
```

#### 2. 错误类型和检验力

```r
# 演示第一类错误和第二类错误

# 1. 第一类错误（Type I Error）- α错误
# 定义：H0为真时，错误地拒绝H0的概率

print("=== 第一类错误演示 ===")
set.seed(456)
n_simulations <- 1000
alpha <- 0.05
type_I_errors <- 0

# 模拟：真实均值确实为5时，进行多次检验
for (i in 1:n_simulations) {
  # 从真实均值为5的总体中抽样
  sample_data <- rnorm(25, mean = 5, sd = 1.2)
  t_stat <- (mean(sample_data) - 5) / (sd(sample_data) / sqrt(25))
  p_val <- 2 * (1 - pt(abs(t_stat), 24))
  
  if (p_val < alpha) {
    type_I_errors <- type_I_errors + 1
  }
}

type_I_rate <- type_I_errors / n_simulations
print(paste("模拟第一类错误率:", round(type_I_rate, 3)))
print(paste("理论第一类错误率:", alpha))

# 2. 第二类错误（Type II Error）- β错误和检验力
print("=== 第二类错误和检验力演示 ===")

# 模拟：真实均值为5.5时，检验H0: μ = 5的检验力
true_mean <- 5.5
n_simulations <- 1000
type_II_errors <- 0

for (i in 1:n_simulations) {
  # 从真实均值为5.5的总体中抽样
  sample_data <- rnorm(25, mean = true_mean, sd = 1.2)
  t_stat <- (mean(sample_data) - 5) / (sd(sample_data) / sqrt(25))
  p_val <- 2 * (1 - pt(abs(t_stat), 24))
  
  if (p_val >= alpha) {  # 没有拒绝H0（错误）
    type_II_errors <- type_II_errors + 1
  }
}

type_II_rate <- type_II_errors / n_simulations  # β
power <- 1 - type_II_rate  # 检验力 = 1 - β

print(paste("第二类错误率 β:", round(type_II_rate, 3)))
print(paste("检验力 (1-β):", round(power, 3)))

# 3. 样本大小对检验力的影响
sample_sizes <- c(10, 20, 30, 50, 100)
powers <- numeric(length(sample_sizes))

for (j in 1:length(sample_sizes)) {
  n <- sample_sizes[j]
  correct_rejections <- 0
  
  for (i in 1:500) {
    sample_data <- rnorm(n, mean = 5.5, sd = 1.2)
    t_stat <- (mean(sample_data) - 5) / (sd(sample_data) / sqrt(n))
    p_val <- 2 * (1 - pt(abs(t_stat), n-1))
    
    if (p_val < alpha) {
      correct_rejections <- correct_rejections + 1
    }
  }
  
  powers[j] <- correct_rejections / 500
}

print("=== 样本大小与检验力 ===")
for (j in 1:length(sample_sizes)) {
  print(paste("n =", sample_sizes[j], ", 检验力 =", round(powers[j], 3)))
}

# 可视化检验力曲线
plot(sample_sizes, powers, 
     type = "b", 
     main = "检验力与样本大小的关系",
     xlab = "样本大小", 
     ylab = "检验力",
     col = "red",
     pch = 19)
abline(h = 0.8, lty = 2, col = "blue")
text(70, 0.85, "常用检验力标准: 0.8", col = "blue")
grid()
```

#### 3. p值的含义和解释

```r
# p值的正确理解

print("=== p值的含义演示 ===")

# 创建一个例子：比较两种肥料对植物生长的影响
set.seed(789)
fertilizer_A <- rnorm(20, mean = 30, sd = 5)
fertilizer_B <- rnorm(20, mean = 35, sd = 5)

# 进行独立样本t检验
t_test_result <- t.test(fertilizer_B, fertilizer_A, var.equal = TRUE)

print("肥料效果比较:")
print(paste("肥料A平均效果:", round(mean(fertilizer_A), 2)))
print(paste("肥料B平均效果:", round(mean(fertilizer_B), 2)))
print(paste("t统计量:", round(t_test_result$statistic, 3)))
print(paste("p值:", round(t_test_result$p.value, 4)))

# p值的正确解释
print("\n=== p值解释 ===")
print("正确解释：")
print(paste("如果两种肥料真的没有差异（H0为真），"))
print(paste("观察到如此极端或更极端差异的概率为:", round(t_test_result$p.value, 4)))

print("\n错误解释：")
print("× H0为真的概率是p值")
print("× 结果是偶然的概率是p值") 
print("× H1为真的概率是1-p值")

# 4. 显著性水平的选择
print("\n=== 不同显著性水平的影响 ===")
alpha_levels <- c(0.01, 0.05, 0.10)

for (alpha in alpha_levels) {
  if (t_test_result$p.value < alpha) {
    decision <- "拒绝H0"
  } else {
    decision <- "不拒绝H0"
  }
  print(paste("α =", alpha, "时的决策:", decision))
}
```

#### 4. 常见假设检验类型

```r
# 1. 单样本t检验
print("=== 单样本t检验 ===")

# 例子：检验某地区鸟类平均体重是否为25克
bird_weights <- rnorm(30, mean = 27, sd = 4)
hypothesized_weight <- 25

# 使用内置函数
one_sample_test <- t.test(bird_weights, mu = hypothesized_weight)
print("检验结果:")
print(paste("样本均值:", round(mean(bird_weights), 2)))
print(paste("t统计量:", round(one_sample_test$statistic, 3)))
print(paste("p值:", round(one_sample_test$p.value, 4)))

# 手动计算验证
t_manual <- (mean(bird_weights) - hypothesized_weight) / 
            (sd(bird_weights) / sqrt(length(bird_weights)))
print(paste("手动计算t统计量:", round(t_manual, 3)))

# 2. 配对样本t检验  
print("\n=== 配对样本t检验 ===")

# 例子：施肥前后植物高度比较
set.seed(321)
before_fertilizer <- rnorm(15, mean = 20, sd = 3)
# 施肥后一般会增加5±2cm
after_fertilizer <- before_fertilizer + rnorm(15, mean = 5, sd = 2)

paired_test <- t.test(after_fertilizer, before_fertilizer, paired = TRUE)
print("配对t检验结果:")
print(paste("平均差异:", round(mean(after_fertilizer - before_fertilizer), 2)))
print(paste("t统计量:", round(paired_test$statistic, 3)))
print(paste("p值:", round(paired_test$p.value, 4)))

# 3. 独立样本t检验
print("\n=== 独立样本t检验 ===")

# 例子：比较两个不同地区的物种多样性
region_A <- rpois(25, lambda = 12)
region_B <- rpois(25, lambda = 15)

# Welch t检验（方差不等）
welch_test <- t.test(region_A, region_B, var.equal = FALSE)
print("独立样本t检验结果:")
print(paste("地区A平均物种数:", round(mean(region_A), 2)))
print(paste("地区B平均物种数:", round(mean(region_B), 2)))
print(paste("t统计量:", round(welch_test$statistic, 3)))
print(paste("p值:", round(welch_test$p.value, 4)))

# 4. 比例检验
print("\n=== 比例检验 ===")

# 例子：检验种子发芽率是否为0.8
germinated <- 85
total_seeds <- 100
hypothesized_prop <- 0.8

prop_test <- prop.test(germinated, total_seeds, p = hypothesized_prop)
print("比例检验结果:")
print(paste("样本比例:", germinated/total_seeds))
print(paste("X²统计量:", round(prop_test$statistic, 3)))
print(paste("p值:", round(prop_test$p.value, 4)))
```

#### 5. 假设检验的实际应用

```r
# 实际生态学研究案例

print("=== 生态学研究案例分析 ===")

# 案例1：入侵物种对本土植物的影响
set.seed(111)

# 有入侵物种的样地
invaded_plots <- rnorm(30, mean = 8, sd = 2.5)  # 本土物种数量
# 无入侵物种的样地  
non_invaded_plots <- rnorm(30, mean = 12, sd = 2.5)

print("案例1：入侵物种对本土植物多样性的影响")
print("H0: 入侵物种对本土植物多样性无影响")
print("H1: 入侵物种显著降低本土植物多样性")

invasion_test <- t.test(invaded_plots, non_invaded_plots, 
                       alternative = "less",  # 单侧检验
                       var.equal = TRUE)

print(paste("有入侵物种样地平均物种数:", round(mean(invaded_plots), 2)))
print(paste("无入侵物种样地平均物种数:", round(mean(non_invaded_plots), 2)))
print(paste("t统计量:", round(invasion_test$statistic, 3)))
print(paste("p值:", round(invasion_test$p.value, 4)))

# 效应大小（Cohen's d）
pooled_sd <- sqrt(((29) * var(invaded_plots) + (29) * var(non_invaded_plots)) / (58))
cohens_d <- (mean(non_invaded_plots) - mean(invaded_plots)) / pooled_sd
print(paste("效应大小 (Cohen's d):", round(cohens_d, 3)))

# 案例2：保护措施的效果评估
print("\n案例2：保护措施对鸟类繁殖成功率的影响")

# 保护前后的繁殖成功情况
before_protection <- c(rep(1, 45), rep(0, 55))  # 45%成功率
after_protection <- c(rep(1, 72), rep(0, 28))   # 72%成功率

print("H0: 保护措施对繁殖成功率无影响")
print("H1: 保护措施显著提高繁殖成功率")

# 两比例检验
protection_test <- prop.test(c(sum(after_protection), sum(before_protection)), 
                           c(length(after_protection), length(before_protection)),
                           alternative = "greater")

print(paste("保护前成功率:", mean(before_protection)))
print(paste("保护后成功率:", mean(after_protection)))
print(paste("X²统计量:", round(protection_test$statistic, 3)))
print(paste("p值:", round(protection_test$p.value, 4)))

# 案例3：多重检验问题
print("\n案例3：多重检验问题演示")

# 同时检验多个物种的丰度变化
set.seed(222)
n_species <- 10
p_values <- numeric(n_species)

print("对10个物种同时进行检验（实际上都无显著变化）:")

for (i in 1:n_species) {
  # 两组数据实际上来自同一分布（H0为真）
  before <- rnorm(20, mean = 10, sd = 2)
  after <- rnorm(20, mean = 10, sd = 2)
  
  test_result <- t.test(before, after)
  p_values[i] <- test_result$p.value
  
  significance <- ifelse(p_values[i] < 0.05, "显著", "不显著")
  print(paste("物种", i, "p值:", round(p_values[i], 4), "-", significance))
}

# Bonferroni校正
bonferroni_alpha <- 0.05 / n_species
print(paste("\nBonferroni校正后的α:", round(bonferroni_alpha, 4)))

significant_after_correction <- sum(p_values < bonferroni_alpha)
print(paste("校正前显著的检验:", sum(p_values < 0.05)))
print(paste("校正后显著的检验:", significant_after_correction))
```

### 统计知识点详解

#### 1. 假设检验基本概念

##### 假设的设立
- **零假设（H₀）**：通常表示"无效果"、"无差异"、"无关系"
- **备择假设（H₁）**：研究者希望证明的假设
- **单侧 vs 双侧检验**：
  - 单侧：H₁指定方向（>或<）
  - 双侧：H₁不指定方向（≠）

##### 检验统计量
- **t统计量**：用于均值检验，特别是小样本
- **z统计量**：用于大样本均值检验或比例检验
- **卡方统计量**：用于方差检验、拟合优度检验等

#### 2. 三种统计检验框架

##### 参数检验（Parametric Analysis）
- **原理**：基于特定分布假设（如正态分布）
- **特点**：
  - 需要满足分布假设
  - 检验效率高（当假设满足时）
  - 提供精确的p值和置信区间
- **生态学应用**：
  - t检验（均值比较）
  - ANOVA（方差分析）
  - 回归分析
- **R示例**：`t.test()`, `aov()`, `lm()`

##### 蒙特卡洛方法（Monte Carlo Analysis）
- **原理**：通过随机抽样模拟统计量的分布
- **特点**：
  - 不依赖严格的分布假设
  - 适用于复杂或未知分布
  - 计算密集型但灵活
- **生态学应用**：
  - 随机化检验
  - 自助法（Bootstrap）
  - 置换检验（Permutation test）
- **R示例**：`boot`包, `coin`包, 自定义模拟

##### 贝叶斯分析（Bayesian Analysis）
- **原理**：基于先验信息和观测数据更新信念
- **特点**：
  - 提供参数的后验分布
  - 直接计算概率陈述
  - 整合先验知识
- **生态学应用**：
  - 参数估计和不确定性量化
  - 模型比较和选择
  - 层次模型和空间分析
- **R示例**：`rstan`, `brms`, `MCMCpack`

#### 2. R中的假设检验函数

##### `t.test()` 函数
- **单样本**：`t.test(x, mu = 0)`
- **配对样本**：`t.test(x, y, paired = TRUE)`
- **独立样本**：`t.test(x, y, var.equal = TRUE/FALSE)`
- **重要参数**：
  - `alternative`：指定备择假设方向
  - `conf.level`：置信水平
  - `var.equal`：是否假设方差相等

##### `prop.test()` 函数
- **语法**：`prop.test(x, n, p = NULL)`
- **参数**：
  - `x`：成功次数
  - `n`：试验总数
  - `p`：假设的比例值

#### 3. 错误类型和检验力

##### 第一类错误（α错误）
- **定义**：H₀为真时错误拒绝H₀的概率
- **控制**：设定显著性水平α
- **常用水平**：0.05, 0.01, 0.10

##### 第二类错误（β错误）
- **定义**：H₀为假时错误接受H₀的概率
- **检验力**：1-β，正确拒绝错误H₀的概率
- **影响因素**：
  - 样本大小
  - 效应大小
  - 显著性水平
  - 总体方差

#### 4. 多重检验校正

##### Bonferroni校正
- **原理**：调整显著性水平为α/m（m为检验次数）
- **优点**：控制家族错误率
- **缺点**：过于保守，降低检验力

##### 其他校正方法
- **Holm方法**：逐步Bonferroni
- **FDR控制**：控制错误发现率
- **R函数**：`p.adjust()`

#### 5. 三种检验框架的比较与选择

##### 方法比较
- **参数检验**：
  - 优点：效率高，结果解释直接
  - 缺点：需要满足严格假设
  - 适用：数据满足正态性、方差齐性等假设

- **蒙特卡洛方法**：
  - 优点：灵活，不依赖分布假设
  - 缺点：计算量大，需要编程
  - 适用：小样本、复杂分布、假设检验

- **贝叶斯分析**：
  - 优点：提供完整概率信息，整合先验知识
  - 缺点：计算复杂，先验选择主观
  - 适用：参数估计、模型比较、不确定性量化

##### 生态学应用指南
- **常规数据分析**：首选参数方法（验证假设后）
- **探索性分析**：蒙特卡洛方法（随机化检验、Bootstrap）
- **复杂模型**：贝叶斯方法（层次模型、空间模型）
- **小样本问题**：蒙特卡洛或贝叶斯方法
- **先验信息可用**：贝叶斯方法

##### R实现建议
- **参数方法**：基础R函数（`t.test`, `aov`, `lm`）
- **蒙特卡洛**：`boot`包（Bootstrap），`coin`包（置换检验）
- **贝叶斯**：`rstan`（Stan），`brms`（贝叶斯回归）

### 课后练习

**题目**：某生态修复项目评估数据：

```r
# 修复前后土壤pH值（配对数据）
before_restoration <- c(4.2, 4.5, 4.1, 4.8, 4.3, 4.6, 4.4, 4.7, 4.2, 4.5,
                       4.3, 4.1, 4.6, 4.4, 4.8, 4.2, 4.5, 4.3, 4.7, 4.1)

after_restoration <- c(5.1, 5.4, 4.9, 5.6, 5.2, 5.5, 5.3, 5.8, 5.0, 5.3,
                      5.2, 4.8, 5.5, 5.1, 5.7, 5.0, 5.4, 5.2, 5.6, 4.9)

# 修复区与对照区的鸟类物种数
restored_area <- c(15, 18, 22, 19, 16, 21, 17, 20, 18, 19, 16, 22, 18, 17, 21)
control_area <- c(12, 10, 14, 11, 13, 9, 15, 12, 10, 13, 11, 14, 12, 9, 16)

# 植物存活情况
total_planted <- 200
survived <- 168
expected_survival_rate <- 0.75  # 期望存活率75%
```

请完成（使用假设检验方法，结合描述统计和概率分布知识）：

1. **配对t检验**：
   - 检验修复措施是否显著提高了土壤pH值
   - 设立假设，选择合适的检验方法
   - 计算并解释p值，得出结论

2. **独立样本t检验**：
   - 比较修复区与对照区的鸟类物种多样性
   - 检验方差是否相等，选择合适的t检验方法
   - 计算效应大小（Cohen's d）

3. **比例检验**：
   - 检验植物存活率是否显著高于预期的75%
   - 使用单侧检验，计算置信区间

4. **检验假设**：
   - 检查数据是否满足t检验的假设条件
   - 进行正态性检验，必要时建议替代方法

5. **多重检验问题**：
   - 如果同时进行以上三个检验，应如何调整显著性水平？
   - 计算Bonferroni校正后的p值

6. **检验力分析**：
   - 计算配对t检验的检验力（假设真实差异为0.5个pH单位）
   - 分析样本大小对检验结果的影响

7. **实际意义解释**：
   - 区分统计显著性和实际意义
   - 从生态学角度解释各检验结果的实际意义
   - 为修复项目管理提供建议

