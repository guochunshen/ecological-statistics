## 时间序列分析基础

### 生态时间序列特点
生态时间序列数据具有以下特征：
- **季节性**: 年周期、月周期等规律性变化
- **趋势性**: 长期上升或下降趋势
- **自相关性**: 相邻时间点的数据相互关联
- **异方差性**: 方差随时间变化
- **缺失值**: 野外监测数据常有缺失

### 平稳性检验

**理论基础**: 平稳性是时间序列分析的重要前提。一个平稳时间序列的统计特性（均值、方差、自相关结构）不随时间变化。生态时间序列常呈现趋势和季节性，需要进行平稳性检验。

**ADF检验 (Augmented Dickey-Fuller)**: 
- 原假设：时间序列有单位根（非平稳）
- 备择假设：时间序列是平稳的
- p值 < 0.05 拒绝原假设，认为序列平稳

**KPSS检验**:
- 原假设：时间序列是平稳的（围绕确定趋势）
- 备择假设：时间序列有单位根
- p值 < 0.05 拒绝原假设，认为序列非平稳

**生态学意义**: 识别种群动态的基础模式，判断是否需要差分处理。

```r
# 加载必要包
library(tseries)
library(forecast)

# 创建示例生态时间序列（鸟类种群数量）
set.seed(123)
bird_population <- ts(rnorm(120, mean = 100, sd = 20) + 
                      sin(2*pi*(1:120)/12)*15 +  # 年周期
                      0.1*(1:120),               # 趋势
                    start = c(2010, 1), frequency = 12)

# 可视化时间序列
autoplot(bird_population) +
  labs(title = "鸟类种群数量时间序列",
       x = "时间", y = "种群数量")

# Augmented Dickey-Fuller平稳性检验
adf.test(bird_population)

# KPSS平稳性检验
kpss.test(bird_population)
```

### 自相关和偏自相关分析

**自相关函数(ACF)**: 衡量时间序列与其自身滞后版本的相关性。对于滞后k，ACF(k) = Corr(X_t, X_{t-k})。ACF图帮助识别：
- 序列的记忆长度（衰减速度）
- 季节性模式（周期性峰值）
- 合适的移动平均阶数(q)

**偏自相关函数(PACF)**: 在控制中间滞后影响后，X_t与X_{t-k}的偏相关。PACF图帮助识别：
- 自回归阶数(p)
- 直接的时间依赖关系

**季节性分解**: 使用STL(Seasonal-Trend decomposition using Loess)将时间序列分解为季节分量、趋势分量和剩余分量。

**生态学应用**: 识别种群波动的内在周期、环境影响的滞后效应、群落动态的时间结构。

```r
# 自相关函数(ACF)
acf(bird_population, main = "自相关函数")

# 偏自相关函数(PACF)  
pacf(bird_population, main = "偏自相关函数")

# 季节性分解
decomposed <- stl(bird_population, s.window = "periodic")
autoplot(decomposed)
```

## 时间序列建模

### ARIMA模型

**ARIMA模型原理**: ARIMA(p,d,q)模型包含三个部分：
- **AR(p)自回归**: 当前值与过去p个值的线性组合
- **I(d)差分**: 对序列进行d阶差分使其平稳
- **MA(q)移动平均**: 当前值与过去q个误差项的线性组合

**模型表达式**: 
(1-φ₁B-...-φ_pB^p)(1-B)^d X_t = c + (1+θ₁B+...+θ_qB^q)ε_t

**参数选择**:
- p: PACF截尾的滞后阶数
- d: 使序列平稳所需的最小差分次数
- q: ACF截尾的滞后阶数

**auto.arima**: 自动选择最优(p,d,q)参数组合，基于AIC/BIC信息准则。

**生态学意义**: 预测种群数量变化、识别密度依赖调节机制、评估管理措施效果。

```r
# 自动ARIMA模型选择
auto_model <- auto.arima(bird_population)
summary(auto_model)

# 模型诊断
checkresiduals(auto_model)

# 预测未来12个月
forecast_result <- forecast(auto_model, h = 12)
autoplot(forecast_result) +
  labs(title = "ARIMA模型预测", x = "时间", y = "种群数量")
```

### 季节性ARIMA(SARIMA)

**SARIMA模型原理**: SARIMA(p,d,q)(P,D,Q)_s扩展ARIMA模型以处理季节性：
- **(p,d,q)**: 非季节性部分
- **(P,D,Q)_s**: 季节性部分，s为季节周期
- **s**: 季节周期长度（月数据s=12，季度数据s=4）

**模型表达式**:
Φ(B^s)φ(B)(1-B^s)^D(1-B)^d X_t = Θ(B^s)θ(B)ε_t

**参数解释**:
- P: 季节性自回归阶数
- D: 季节性差分阶数  
- Q: 季节性移动平均阶数

**适用场景**: 具有明显季节周期的生态数据，如：
- 季节性迁徙种群
- 物候周期性变化
- 气候季节性波动

**生态学意义**: 分离季节效应和长期趋势，更准确预测季节性生态现象。

```r
# 季节性ARIMA模型
sarima_model <- Arima(bird_population, 
                     order = c(1,1,1), 
                     seasonal = c(1,1,1))

# 模型比较
AIC(auto_model, sarima_model)
```

### 状态空间模型

**状态空间模型原理**: 将时间序列分解为不可观测的状态变量和观测方程：

**状态方程**: α_t = T_t α_{t-1} + R_t η_t, η_t ~ N(0, Q_t)
**观测方程**: y_t = Z_t α_t + ε_t, ε_t ~ N(0, H_t)

其中：
- α_t: 状态向量（不可观测的真实状态）
- y_t: 观测向量（实际测量值）
- T_t: 状态转移矩阵
- Z_t: 观测矩阵
- η_t, ε_t: 过程噪声和观测噪声

**卡尔曼滤波**: 递归算法，通过预测-更新步骤估计状态向量：
1. 预测下一状态和协方差
2. 计算卡尔曼增益
3. 用新观测更新状态估计
4. 更新协方差估计

**生态学优势**:
- 处理缺失数据能力强
- 可估计不可观测生态过程
- 灵活处理非线性关系
- 适合种群动态的状态估计

```r
library(dlm)

# 简单局部水平模型
buildSSM <- function(theta) {
  dlmModPoly(order = 1, dV = exp(theta[1]), dW = exp(theta[2]))
}

# 参数估计
fit <- dlmMLE(bird_population, parm = c(0,0), build = buildSSM)
ssm_model <- buildSSM(fit$par)

# 卡尔曼滤波
filtered <- dlmFilter(bird_population, ssm_model)
```

### GAM时间序列

**广义可加模型(GAM)原理**: GAM扩展广义线性模型，允许使用平滑函数处理非线性关系：

g(μ) = β₀ + f₁(x₁) + f₂(x₂) + ... + f_p(x_p)

其中f_j为平滑函数，常用样条基函数表示。

**时间序列GAM特点**:
- 可同时建模趋势、季节性和其他协变量效应
- 使用循环样条(bs="cc")处理季节性周期
- 自动选择平滑度参数（通过GCV或REML）
- 可处理非正态分布数据

**平滑函数类型**:
- 薄板样条: 各向同性平滑
- 张量积样条: 变量间交互作用
- 循环样条: 周期性变量

**生态学应用优势**:
- 灵活捕捉复杂的非线性生态关系
- 可整合环境因子和时空效应
- 提供可解释的平滑函数估计
- 适合生态数据的非参数建模

```r
library(mgcv)

# 创建时间变量
time_index <- 1:length(bird_population)
season <- cycle(bird_population)

gam_model <- gam(bird_population ~ s(time_index) + s(season, bs = "cc"),
                 method = "REML")

summary(gam_model)
plot(gam_model, pages = 1)
```

## 生态应用案例

### 种群动态监测

**多变量时间序列分析**: 生态系统中多个物种的种群动态往往相互关联，需要多变量分析方法。

**VAR模型 (向量自回归)**:
Y_t = c + A₁Y_{t-1} + A₂Y_{t-2} + ... + A_pY_{t-p} + ε_t

其中Y_t为多变量时间序列向量，A_i为系数矩阵。

**格兰杰因果关系**: 检验一个变量是否有助于预测另一个变量。如果物种A的过去值能提高对物种B的预测精度，则称A格兰杰引起B。

**脉冲响应分析**: 分析一个变量的冲击对其他变量的动态影响，揭示物种间的相互作用强度和方向。

**生态学意义**:
- 识别物种间的竞争、捕食、互惠关系
- 理解群落动态的因果结构
- 预测多物种系统的协同变化
- 评估生态网络稳定性

```r
# 模拟多物种种群数据
set.seed(456)
species_data <- data.frame(
  time = 1:60,
  species_A = arima.sim(list(ar = 0.7), n = 60, mean = 50) + 5*sin(2*pi*(1:60)/12),
  species_B = arima.sim(list(ar = 0.5), n = 60, mean = 30) + 3*sin(2*pi*(1:60)/12 + pi/2),
  species_C = arima.sim(list(ar = 0.3), n = 60, mean = 20) + 2*sin(2*pi*(1:60)/12 + pi)
)

# 多变量时间序列分析
library(vars)
var_model <- VAR(species_data[, -1], p = 2)
summary(var_model)

# 格兰杰因果检验
causality(var_model, cause = "species_A")
```

### 物候变化分析

**物候时间序列特点**: 物候事件（开花、结果、迁徙等）的时间序列具有：
- 年际变异性和长期趋势
- 受气候因子强烈影响
- 可能呈现非线性变化
- 存在阈值效应和突变点

**趋势分析方法**:
- **线性回归**: 简单趋势检测，但可能低估复杂性
- **时间序列回归**: 包含自相关结构的回归模型
- **突变点检测**: 识别物候制度的突然变化
- **分位数回归**: 分析不同分位点的变化趋势

**气候-物候关系**:
- 温度累积模型（度日模型）
- 光周期效应
- 冬季 chilling 需求
- 极端事件影响

**生态学意义**:
- 监测气候变化对生态系统的影响
- 预测物种分布范围变化
- 评估生态系统的物候匹配
- 保护生物多样性

```r
# 物候数据（开花时间）
flowering_data <- data.frame(
  year = 1990:2020,
  flowering_date = rnorm(31, mean = 120 - 0.3*(1990:2020 - 1990), sd = 5)
)

# 趋势分析
trend_model <- lm(flowering_date ~ year, data = flowering_data)
summary(trend_model)

# 时间序列回归
library(dynlm)
dyn_model <- dynlm(flowering_date ~ L(flowering_date, 1) + year, 
                  data = flowering_data)
summary(dyn_model)
```

### 气候数据时间序列

**气候时间序列特征**: 气候数据通常呈现：
- 强烈的季节性和年际变率
- 长期趋势（如全球变暖）
- 空间相关性和尺度依赖性
- 极端事件和突变行为

**气候突变点检测**: 识别气候制度的突然变化，如：
- 气候转型期（如1976年太平洋年代际振荡转变）
- 政策干预效果（如减排措施）
- 生态系统阈值跨越

**结构突变检验方法**:
- **Chow检验**: 已知突变点的检验
- **Bai-Perron检验**: 多个未知突变点检测
- **CUSUM检验**: 累积和检验
- **递归残差检验**: 基于递归估计的检验

**生态气候学应用**:
- 气候-生态关系非线性分析
- 生态系统对气候突变的响应
- 气候变化影响评估
- 生态适应性管理

```r
# 温度数据时间序列分析
temperature_data <- data.frame(
  date = seq.Date(as.Date("2000-01-01"), as.Date("2020-12-31"), by = "month"),
  temperature = rnorm(252, mean = 15 + 0.02*(1:252), sd = 3) + 
                5*sin(2*pi*(1:252)/12)
)

# 转换为时间序列对象
temp_ts <- ts(temperature_data$temperature, 
              start = c(2000, 1), frequency = 12)

# 检测突变点
library(strucchange)
breakpoints(temperature ~ 1, data = temperature_data)
```

## 生存分析

**生存分析基本概念**: 分析事件发生时间的数据，考虑右删失（censoring）情况。

**生存函数**: S(t) = P(T > t)，个体存活超过时间t的概率
**风险函数**: h(t) = lim(Δt→0) P(t ≤ T < t+Δt | T ≥ t)/Δt，瞬时死亡风险

### Kaplan-Meier生存曲线

**Kaplan-Meier估计**: 非参数方法估计生存函数：
Ŝ(t) = ∏_{t_i ≤ t} (1 - d_i/n_i)

其中d_i为时间t_i的事件数，n_i为风险集大小。

**曲线特点**:
- 阶梯函数，在事件时间点下降
- 可比较不同组的生存经验
- 提供中位生存时间等统计量

**生态学应用**:
- 动物存活率研究
- 植物寿命分析  
- 保护物种生存评估
- 管理措施效果评价

```r
library(survival)

# 模拟生存数据（标记重捕研究）
survival_data <- data.frame(
  time = c(1,2,3,4,5,2,3,4,1,2,3,4,5,6),
  status = c(1,1,0,1,0,1,1,0,1,0,1,1,0,1),  # 1=死亡, 0=删失
  group = rep(c("A", "B"), each = 7)
)

# Kaplan-Meier估计
km_fit <- survfit(Surv(time, status) ~ group, data = survival_data)
summary(km_fit)

# 生存曲线图
plot(km_fit, col = c("blue", "red"), 
     xlab = "时间", ylab = "生存概率",
     main = "Kaplan-Meier生存曲线")
legend("topright", legend = c("组A", "组B"), col = c("blue", "red"), lty = 1)
```

### Cox比例风险模型

**Cox比例风险模型**: 半参数模型，分析协变量对风险率的影响：

h(t|X) = h₀(t) exp(β₁X₁ + β₂X₂ + ... + β_pX_p)

其中h₀(t)为基准风险函数，不需要指定具体形式。

**模型特点**:
- 比例风险假设：协变量效应不随时间变化
- 部分似然估计：避免指定基准风险函数
- 可处理时间依赖协变量

**比例风险检验**: 使用cox.zph()检验比例风险假设，如果p<0.05则假设可能不成立。

**参数解释**:
- 风险比(HR) = exp(β)：协变量增加1单位的相对风险
- HR > 1: 增加死亡风险
- HR < 1: 降低死亡风险
- HR = 1: 无影响

**生态学应用**: 分析年龄、性别、体型、环境因子等对生存的影响。

```r
# 添加协变量
survival_data$age <- c(rep(1, 7), rep(2, 7))  # 年龄组
survival_data$size <- rnorm(14, mean = 10, sd = 2)  # 个体大小

# Cox模型
cox_model <- coxph(Surv(time, status) ~ group + age + size, 
                   data = survival_data)
summary(cox_model)

# 比例风险假设检验
cox.zph(cox_model)
```

### 标记重捕分析

**标记重捕方法**: 通过多次捕获、标记、释放来估计种群参数：

**Jolly-Seber模型**: 开种群标记重捕分析，允许：
- 新个体加入（出生、迁入）
- 个体消失（死亡、迁出）
- 捕获概率变化

**主要估计参数**:
- **种群大小(N)**: 特定时间的种群数量
- **存活率(φ)**: 个体从t到t+1存活的概率
- **招募率(f)**: 新个体加入率
- **捕获概率(p)**: 每次捕获时被捕获的概率

**模型假设**:
1. 标记不影响存活和捕获概率
2. 标记不丢失
3. 捕获瞬间完成
4. 个体间同质性（可放松）

**生态学应用**:
- 野生动物种群监测
- 保护物种数量估计
- 种群动态参数估计
- 管理措施效果评估

```r
library(marked)

# Jolly-Seber模型示例
# 创建标记重捕数据格式
capture_history <- matrix(c(
  1,1,0,1,0,  # 个体1
  1,0,1,0,0,  # 个体2
  0,1,1,1,1,  # 个体3
  1,1,1,0,0,  # 个体4
  0,0,1,1,1   # 个体5
), nrow = 5, byrow = TRUE)

# 简单模型拟合
# 实际应用中需要更复杂的数据准备和模型设定
js_model <- mark(capture_history, model = "JollySeber")
summary(js_model)
```

## R实现实用代码示例

### 综合时间序列分析流程
```r
# 完整的时间序列分析流程
complete_analysis <- function(ts_data, series_name = "Time Series") {
  
  # 1. 数据探索
  cat("=== 时间序列探索性分析 ===\n")
  print(summary(ts_data))
  
  # 2. 平稳性检验
  cat("\n=== 平稳性检验 ===\n")
  adf_test <- adf.test(ts_data)
  print(adf_test)
  
  # 3. 季节性分解
  decomp <- stl(ts_data, s.window = "periodic")
  
  # 4. ARIMA建模
  best_model <- auto.arima(ts_data)
  cat("\n=== ARIMA模型结果 ===\n")
  print(summary(best_model))
  
  # 5. 预测
  forecast_values <- forecast(best_model, h = 12)
  
  # 6. 可视化
  autoplot(forecast_values) +
    labs(title = paste("时间序列分析与预测:", series_name),
         x = "时间", y = "值")
}

# 使用示例
complete_analysis(bird_population, "鸟类种群数量")
```

### 生存分析自动化报告
```r
# 生存分析自动化报告
auto_survival_report <- function(surv_data, time_var, status_var, group_var = NULL) {
  
  # 创建生存对象
  surv_obj <- Surv(surv_data[[time_var]], surv_data[[status_var]])
  
  if (!is.null(group_var)) {
    km_fit <- survfit(surv_obj ~ surv_data[[group_var]])
    
    # 组间比较
    surv_diff <- survdiff(surv_obj ~ surv_data[[group_var]])
    
    cat("=== 组间生存差异比较 ===\n")
    print(surv_diff)
    
  } else {
    km_fit <- survfit(surv_obj ~ 1)
  }
  
  # 生存曲线图
  plot(km_fit, main = "生存曲线", xlab = "时间", ylab = "生存概率")
  
  # 中位生存时间
  cat("\n=== 中位生存时间 ===\n")
  print(quantile(km_fit, probs = 0.5))
  
  return(km_fit)
}

# 使用示例
auto_survival_report(survival_data, "time", "status", "group")
```

### 项目实施流程

#### 第一阶段：项目准备与数据导入

```r
# 1. 项目环境设置
# 创建项目文件夹结构
# 山地森林项目/
# ├── 数据/
# ├── 脚本/
# ├── 结果/
# │   ├── 图表/
# │   └── 统计结果/
# └── 报告/

# 2. 加载必要的R包
library(tidyverse)    # 数据处理和可视化
library(vegan)        # 生态学分析（需要安装）
library(corrplot)     # 相关性分析可视化
library(knitr)        # 报告生成
library(rmarkdown)    # 动态报告

# 3. 数据导入和初步检查
# 创建模拟数据集（实际项目中从文件读取）
set.seed(123)

# 样地基本信息
site_info <- data.frame(
  site_id = paste0("Site_", sprintf("%02d", 1:24)),
  elevation = rep(c(800, 1200, 1600, 2000), each = 6),
  elevation_zone = rep(c("低海拔", "中低海拔", "中高海拔", "高海拔"), each = 6),
  slope = runif(24, 5, 35),
  aspect = sample(c("北", "南", "东", "西"), 24, replace = TRUE),
  area_m2 = rep(400, 24)  # 20m × 20m 样方
)

# 植物群落数据（三年数据）
vegetation_data <- expand.grid(
  site_id = paste0("Site_", sprintf("%02d", 1:24)),
  year = 2020:2022,
  species = paste0("Species_", LETTERS[1:15])
) %>%
  mutate(
    abundance = rpois(nrow(.), lambda = ifelse(
      str_sub(species, -1) %in% LETTERS[1:5], 8,   # 常见种
      ifelse(str_sub(species, -1) %in% LETTERS[6:10], 3, 1)  # 稀有种
    ))
  ) %>%
  filter(abundance > 0)  # 只保留出现的物种

# 环境数据
environmental_data <- expand.grid(
  site_id = paste0("Site_", sprintf("%02d", 1:24)),
  year = 2020:2022
) %>%
  left_join(site_info, by = "site_id") %>%
  mutate(
    temperature = 20 - elevation/100 + rnorm(nrow(.), 0, 2),
    precipitation = 1000 + elevation/2 + rnorm(nrow(.), 0, 100),
    soil_ph = 6.5 + rnorm(nrow(.), 0, 0.5),
    soil_organic_matter = 3 + elevation/500 + rnorm(nrow(.), 0, 1),
    canopy_cover = pmax(0, pmin(100, 70 + elevation/50 + rnorm(nrow(.), 0, 15)))
  )

# 物种特征数据
species_traits <- data.frame(
  species = paste0("Species_", LETTERS[1:15]),
  growth_form = sample(c("乔木", "灌木", "草本"), 15, replace = TRUE, 
                      prob = c(0.3, 0.3, 0.4)),
  max_height = ifelse(
    c(rep("乔木", 5), rep("灌木", 5), rep("草本", 5)) == "乔木", 
    rnorm(15, 15, 5),
    ifelse(c(rep("乔木", 5), rep("灌木", 5), rep("草本", 5)) == "灌木",
           rnorm(15, 3, 1), rnorm(15, 0.5, 0.2))
  ),
  leaf_area = rlnorm(15, 2, 0.5),
  seed_mass = rlnorm(15, 0, 1)
)

# 4. 数据质量检查
print("=== 数据集概况 ===")
cat("样地信息:", nrow(site_info), "个样地\n")
cat("植物群落记录:", nrow(vegetation_data), "条记录\n") 
cat("环境数据:", nrow(environmental_data), "条记录\n")
cat("物种特征:", nrow(species_traits), "个物种\n")

# 检查缺失值
cat("\n=== 缺失值检查 ===\n")
cat("样地信息缺失值:", sum(is.na(site_info)), "\n")
cat("植物群落缺失值:", sum(is.na(vegetation_data)), "\n")
cat("环境数据缺失值:", sum(is.na(environmental_data)), "\n")
```

#### 第二阶段：探索性数据分析

```r
# 1. 群落结构分析
# 计算多样性指数
diversity_indices <- vegetation_data %>%
  group_by(site_id, year) %>%
  summarise(
    species_richness = n_distinct(species),
    total_abundance = sum(abundance),
    shannon_index = -sum((abundance/sum(abundance)) * log(abundance/sum(abundance))),
    simpson_index = sum((abundance/sum(abundance))^2),
    .groups = 'drop'
  ) %>%
  mutate(simpson_diversity = 1 - simpson_index)

# 合并海拔信息
diversity_with_elevation <- diversity_indices %>%
  left_join(site_info, by = "site_id")

# 2. 海拔梯度的多样性变化
diversity_elevation_plot <- ggplot(diversity_with_elevation, 
                                  aes(x = elevation, y = species_richness)) +
  geom_point(aes(color = elevation_zone), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  facet_wrap(~ year, labeller = label_both) +
  scale_color_viridis_d(name = "海拔带") +
  labs(
    title = "海拔梯度上的物种丰富度变化",
    subtitle = "2020-2022年监测结果",
    x = "海拔 (m)",
    y = "物种丰富度",
    caption = "数据来源：山地森林生态系统监测项目"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    strip.background = element_rect(fill = "lightgray")
  )

print(diversity_elevation_plot)

# 3. 群落组成分析
# 计算物种组成矩阵
community_matrix <- vegetation_data %>%
  filter(year == 2022) %>%  # 分析最新一年的数据
  select(site_id, species, abundance) %>%
  pivot_wider(names_from = species, values_from = abundance, values_fill = 0) %>%
  column_to_rownames("site_id")

# 群落相似性分析（简化版）
community_summary <- vegetation_data %>%
  filter(year == 2022) %>%
  left_join(site_info, by = "site_id") %>%
  group_by(elevation_zone, species) %>%
  summarise(mean_abundance = mean(abundance), .groups = 'drop') %>%
  arrange(elevation_zone, desc(mean_abundance))

# 优势物种分析
dominant_species <- community_summary %>%
  group_by(elevation_zone) %>%
  slice_max(mean_abundance, n = 3) %>%
  mutate(rank = row_number())

dominant_species_plot <- ggplot(dominant_species, 
                               aes(x = reorder(species, mean_abundance), 
                                   y = mean_abundance, 
                                   fill = elevation_zone)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~ elevation_zone, scales = "free") +
  labs(
    title = "各海拔带优势物种组成",
    x = "物种",
    y = "平均丰度",
    fill = "海拔带"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

print(dominant_species_plot)
```

#### 第三阶段：环境因子影响分析

```r
# 1. 环境因子与多样性的关系
# 合并环境数据和多样性数据
env_diversity <- diversity_indices %>%
  left_join(environmental_data, by = c("site_id", "year"))

# 相关性分析
env_vars <- c("temperature", "precipitation", "soil_ph", 
             "soil_organic_matter", "canopy_cover")
diversity_vars <- c("species_richness", "shannon_index", "simpson_diversity")

correlation_matrix <- env_diversity %>%
  select(all_of(c(env_vars, diversity_vars))) %>%
  cor(use = "complete.obs")

# 可视化相关性矩阵
library(corrplot)
corrplot(correlation_matrix, method = "color", type = "upper",
         order = "hclust", tl.cex = 0.8, tl.col = "black")

# 2. 多元回归分析
# 物种丰富度与环境因子的关系
richness_model <- lm(species_richness ~ elevation + temperature + 
                    precipitation + soil_ph + canopy_cover, 
                    data = env_diversity)

summary(richness_model)

# 模型诊断
par(mfrow = c(2, 2))
plot(richness_model)
par(mfrow = c(1, 1))

# 3. 环境因子的海拔梯度变化
env_gradient_data <- environmental_data %>%
  select(site_id, elevation, temperature, precipitation, soil_organic_matter) %>%
  pivot_longer(cols = c(temperature, precipitation, soil_organic_matter),
               names_to = "environmental_factor", values_to = "value")

env_gradient_plot <- ggplot(env_gradient_data, 
                           aes(x = elevation, y = value)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +
  facet_wrap(~ environmental_factor, scales = "free_y",
             labeller = labeller(environmental_factor = 
                               c("temperature" = "温度 (°C)",
                                 "precipitation" = "降水量 (mm)",
                                 "soil_organic_matter" = "土壤有机质 (%)"))) +
  labs(
    title = "环境因子的海拔梯度变化",
    x = "海拔 (m)",
    y = "测量值"
  ) +
  theme_bw()

print(env_gradient_plot)
```

#### 第四阶段：时间动态分析

```r
# 1. 多样性的年际变化
temporal_diversity <- diversity_indices %>%
  left_join(site_info, by = "site_id") %>%
  group_by(elevation_zone, year) %>%
  summarise(
    mean_richness = mean(species_richness),
    se_richness = sd(species_richness) / sqrt(n()),
    mean_shannon = mean(shannon_index),
    se_shannon = sd(shannon_index) / sqrt(n()),
    .groups = 'drop'
  )

# 物种丰富度时间变化
temporal_plot <- ggplot(temporal_diversity, 
                       aes(x = factor(year), y = mean_richness, 
                           color = elevation_zone, group = elevation_zone)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_richness - se_richness,
                    ymax = mean_richness + se_richness),
                width = 0.1) +
  scale_color_viridis_d(name = "海拔带") +
  labs(
    title = "不同海拔带物种丰富度的时间变化",
    x = "年份",
    y = "平均物种丰富度",
    color = "海拔带"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "bottom"
  )

print(temporal_plot)

# 2. 群落稳定性分析
community_stability <- diversity_indices %>%
  group_by(site_id) %>%
  summarise(
    mean_richness = mean(species_richness),
    cv_richness = sd(species_richness) / mean(species_richness) * 100,
    .groups = 'drop'
  ) %>%
  left_join(site_info, by = "site_id")

stability_plot <- ggplot(community_stability, 
                        aes(x = elevation_zone, y = cv_richness)) +
  geom_boxplot(aes(fill = elevation_zone), alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.6) +
  labs(
    title = "不同海拔带群落稳定性比较",
    subtitle = "变异系数越小表示稳定性越高",
    x = "海拔带",
    y = "物种丰富度变异系数 (%)",
    fill = "海拔带"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

print(stability_plot)
```

#### 第五阶段：综合分析与报告

```r
# 1. 创建综合分析图表
# 四面板综合图
library(gridExtra)

# 面板1：多样性-海拔关系
panel1 <- ggplot(diversity_with_elevation, 
                 aes(x = elevation, y = species_richness)) +
  geom_point(aes(color = elevation_zone), alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "A. 多样性-海拔关系", x = "海拔(m)", y = "物种丰富度") +
  theme_minimal() + theme(legend.position = "none")

# 面板2：环境梯度
panel2 <- ggplot(env_diversity, aes(x = elevation, y = temperature)) +
  geom_point(alpha = 0.6, color = "red") +
  geom_smooth(method = "lm", se = FALSE, color = "darkred") +
  labs(title = "B. 温度梯度", x = "海拔(m)", y = "温度(°C)") +
  theme_minimal()

# 面板3：时间变化
panel3 <- ggplot(temporal_diversity, 
                 aes(x = year, y = mean_richness, color = elevation_zone)) +
  geom_line(aes(group = elevation_zone)) +
  geom_point() +
  labs(title = "C. 时间动态", x = "年份", y = "平均物种丰富度") +
  theme_minimal() + theme(legend.position = "none")

# 面板4：群落稳定性
panel4 <- ggplot(community_stability, aes(x = elevation_zone, y = cv_richness)) +
  geom_boxplot(alpha = 0.7, fill = "lightblue") +
  labs(title = "D. 群落稳定性", x = "海拔带", y = "变异系数(%)") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 组合图表
comprehensive_plot <- grid.arrange(panel1, panel2, panel3, panel4, ncol = 2)

# 2. 统计分析总结
cat("=== 山地森林生态系统分析结果 ===\n\n")

# 海拔-多样性关系
elevation_diversity_cor <- cor(diversity_with_elevation$elevation, 
                              diversity_with_elevation$species_richness)
cat("1. 海拔与物种丰富度相关系数:", round(elevation_diversity_cor, 3), "\n")

# 年际变化分析
yearly_change <- temporal_diversity %>%
  group_by(elevation_zone) %>%
  summarise(
    richness_change = last(mean_richness) - first(mean_richness),
    .groups = 'drop'
  )
cat("\n2. 各海拔带3年间物种丰富度变化:\n")
print(yearly_change)

# 环境因子重要性
cat("\n3. 环境因子对物种丰富度的影响 (回归系数):\n")
model_summary <- summary(richness_model)
significant_factors <- which(model_summary$coefficients[, 4] < 0.05)
cat("显著影响因子:\n")
print(model_summary$coefficients[significant_factors, ])

# 3. 生态学结论
cat("\n=== 主要发现 ===\n")
cat("1. 物种多样性随海拔呈", 
    ifelse(elevation_diversity_cor > 0, "正相关", "负相关"), "趋势\n")
cat("2. 高海拔区群落相对稳定，低海拔区变异较大\n")
cat("3. 温度是影响物种分布的主要环境因子\n")
cat("4. 不同海拔带群落组成存在明显差异\n")
```

### 项目知识点总结

#### 1. 完整项目工作流程
- **项目规划**：文件组织、环境设置
- **数据管理**：导入、清理、质量控制
- **探索性分析**：描述统计、可视化
- **假设检验**：统计建模、显著性检验
- **结果解释**：生态学意义、局限性讨论
- **报告撰写**：图表制作、结论总结

#### 2. 生态学分析方法
- **多样性指数**：Shannon、Simpson指数
- **群落分析**：组成分析、相似性比较
- **环境关系**：梯度分析、相关性分析
- **时间序列**：年际变化、稳定性评估
- **多元统计**：回归分析、模型诊断

#### 3. 数据科学技能
- **数据整理**：tidyverse工作流
- **统计分析**：假设检验、模型构建
- **可视化**：ggplot2高级应用
- **项目管理**：代码组织、结果管理
- **科学写作**：结果报告、图表说明

#### 4. R编程进阶应用
- **函数式编程**：自定义函数、apply族函数
- **数据结构**：复杂数据的处理和转换
- **包的使用**：专业包的学习和应用
- **代码优化**：效率考虑、最佳实践
- **错误调试**：问题诊断、解决策略

### 课后项目扩展

学生可以基于这个框架开展自己的研究项目：

1. **数据收集**：设计野外调查方案，收集真实数据
2. **方法改进**：尝试更复杂的生态学分析方法
3. **假设检验**：提出科学假设，设计验证方案
4. **论文写作**：将分析结果写成科学论文格式
5. **同行交流**：在学术会议上展示研究成果

这个综合项目整合了前11课的所有内容，为学生提供了完整的生态学R语言应用体验，培养了从问题提出到结果报告的全流程数据分析能力。

