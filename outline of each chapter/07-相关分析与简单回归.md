## 第17课：相关分析与简单回归

### 生态学背景
在生态学研究中，理解环境因子与生物响应之间的定量关系是核心问题之一。例如，温度如何影响植物的生长速率？降雨量与物种多样性之间存在怎样的关系？海拔高度对鸟类群落结构有什么影响？相关分析和简单回归为这些问题提供了统计工具，帮助我们量化变量间的线性关系强度和预测能力。

### 演示数据
```r
# 某山地生态系统海拔梯度调查数据
set.seed(123)
elevation_gradient <- data.frame(
  site_id = paste0("S", sprintf("%02d", 1:30)),
  elevation = seq(1000, 2900, by = 100) + rnorm(30, 0, 50),
  temperature = 20 - 0.006 * seq(1000, 2900, by = 100) + rnorm(30, 0, 1.5),
  species_richness = 25 + 0.01 * seq(1000, 2900, by = 100) - 0.000003 * seq(1000, 2900, by = 100)^2 + rnorm(30, 0, 3),
  soil_ph = 6.5 + 0.0003 * seq(1000, 2900, by = 100) + rnorm(30, 0, 0.3),
  biomass_kg_ha = 150 - 0.03 * seq(1000, 2900, by = 100) + rnorm(30, 0, 15)
)
```

### 课堂演示过程

#### 1. 相关分析基础
```r
# 创建海拔梯度数据
set.seed(123)
elevation_data <- data.frame(
  elevation = seq(1000, 2500, by = 100),
  temperature = 20 - 0.006 * seq(1000, 2500, by = 100) + rnorm(16, 0, 1),
  species_count = 15 + 0.008 * seq(1000, 2500, by = 100) + rnorm(16, 0, 2)
)

# 1. 计算相关系数
cor_temp_elev <- cor(elevation_data$elevation, elevation_data$temperature)
cor_species_elev <- cor(elevation_data$elevation, elevation_data$species_count)
cor_temp_species <- cor(elevation_data$temperature, elevation_data$species_count)

print(paste("海拔与温度相关性:", round(cor_temp_elev, 3)))
print(paste("海拔与物种数相关性:", round(cor_species_elev, 3)))
print(paste("温度与物种数相关性:", round(cor_temp_species, 3)))

# 2. 相关性显著性检验
cor.test(elevation_data$elevation, elevation_data$temperature)
cor.test(elevation_data$elevation, elevation_data$species_count)

# 3. 相关矩阵计算
cor_matrix <- cor(elevation_data[, c("elevation", "temperature", "species_count")])
print(cor_matrix)
```

#### 2. 散点图与相关性可视化
```r
# 基础散点图
plot(elevation_data$elevation, elevation_data$temperature,
     xlab = "海拔 (m)", ylab = "温度 (°C)",
     main = "海拔与温度关系",
     pch = 19, col = "blue")

# 添加相关系数到图上
text(1200, 18, paste("r =", round(cor_temp_elev, 3)), pos = 4)

# 多个变量的散点图矩阵
pairs(elevation_data[, c("elevation", "temperature", "species_count")],
      main = "变量间关系矩阵")
```

#### 3. 简单线性回归分析
```r
# 1. 建立回归模型
temp_model <- lm(temperature ~ elevation, data = elevation_data)
species_model <- lm(species_count ~ elevation, data = elevation_data)

# 2. 查看回归结果
summary(temp_model)
summary(species_model)

# 3. 提取重要信息
temp_r_squared <- summary(temp_model)$r.squared
temp_p_value <- summary(temp_model)$coefficients[2, 4]
temp_slope <- coef(temp_model)[2]
temp_intercept <- coef(temp_model)[1]

print(paste("温度模型 R² =", round(temp_r_squared, 3)))
print(paste("斜率 =", round(temp_slope, 6), "°C/m"))
print(paste("p值 =", round(temp_p_value, 6)))
```

#### 4. 回归线绘制和预测
```r
# 绘制回归线
plot(elevation_data$elevation, elevation_data$temperature,
     xlab = "海拔 (m)", ylab = "温度 (°C)",
     main = "海拔与温度线性关系",
     pch = 19, col = "blue")

# 添加回归线
abline(temp_model, col = "red", lwd = 2)

# 添加回归方程
equation <- paste("温度 =", round(temp_intercept, 2), "+", 
                 round(temp_slope, 6), "× 海拔")
text(1200, 18, equation, pos = 4, col = "red")
text(1200, 17, paste("R² =", round(temp_r_squared, 3)), pos = 4, col = "red")

# 进行预测
new_elevations <- data.frame(elevation = c(1800, 2200, 2600))
predicted_temps <- predict(temp_model, new_elevations, interval = "prediction")
print(predicted_temps)
```

#### 5. 回归诊断
```r
# 1. 残差分析
par(mfrow = c(2, 2))

# 残差vs拟合值图
plot(fitted(temp_model), residuals(temp_model),
     xlab = "拟合值", ylab = "残差",
     main = "残差vs拟合值")
abline(h = 0, col = "red", lty = 2)

# Q-Q图检验正态性
qqnorm(residuals(temp_model), main = "残差Q-Q图")
qqline(residuals(temp_model), col = "red")

# 残差直方图
hist(residuals(temp_model), main = "残差分布", 
     xlab = "残差", breaks = 8, col = "lightblue")

# 残差vs海拔图
plot(elevation_data$elevation, residuals(temp_model),
     xlab = "海拔", ylab = "残差",
     main = "残差vs海拔")
abline(h = 0, col = "red", lty = 2)

par(mfrow = c(1, 1))

# 2. 正态性检验
shapiro.test(residuals(temp_model))

# 3. 模型诊断图（R内置）
plot(temp_model)
```

### R语言知识点详解

#### 1. 相关分析深入

##### 皮尔逊相关系数
- **适用条件**：
  - 变量为连续型数据
  - 变量呈线性关系
  - 数据近似正态分布
- **解释**：
  - r = 1: 完全正相关
  - r = -1: 完全负相关
  - r = 0: 无线性相关
  - |r| > 0.7: 强相关
  - 0.3 < |r| < 0.7: 中等相关
  - |r| < 0.3: 弱相关

##### `cor.test()` 函数详解
- **语法**：`cor.test(x, y, method = "pearson", alternative = "two.sided")`
- **参数说明**：
  - `method`: "pearson", "spearman", "kendall"
  - `alternative`: "two.sided", "greater", "less"
  - `conf.level`: 置信水平，默认0.95
- **输出解释**：
  - t统计量和p值
  - 相关系数及其置信区间
  - 原假设：真实相关系数等于0

##### 非参数相关
- **Spearman等级相关**：
  - 适用于单调关系（不一定线性）
  - 对异常值稳健
  - 适用于有序分类数据
- **Kendall相关**：
  - 基于秩次一致性
  - 样本量小时更稳健
  - 解释更直观

#### 2. 简单线性回归深入

##### 回归模型假设
1. **线性关系**：Y与X之间存在线性关系
2. **独立性**：观察值之间相互独立
3. **同方差性**：残差方差恒定
4. **正态性**：残差服从正态分布
5. **无多重共线性**：（多元回归时）

##### `lm()` 函数详解
- **语法**：`lm(formula, data, subset, weights, na.action)`
- **公式语法**：
  - `y ~ x`: 简单线性回归
  - `y ~ x + 0`: 通过原点的回归
  - `y ~ I(x^2)`: 二次项回归
  - `y ~ log(x)`: 对数变换

##### 回归结果解读
- **Coefficients表**：
  - Estimate: 系数估计值
  - Std. Error: 标准误
  - t value: t统计量
  - Pr(>|t|): p值
- **模型拟合度**：
  - Multiple R-squared: 决定系数
  - Adjusted R-squared: 调整决定系数
  - F-statistic: F检验统计量
  - p-value: 模型整体显著性

#### 3. 回归诊断技术

##### 残差分析
- **残差vs拟合值图**：
  - 检查线性关系假设
  - 发现异方差问题
  - 识别异常值
- **Q-Q图**：
  - 检验残差正态性
  - 点应沿直线分布
  - 偏离直线表示非正态

##### 影响点识别
- **杠杆值(Leverage)**：衡量X值的极端程度
- **Cook距离**：衡量观测点对回归的影响
- **标准化残差**：标准化的残差值

#### 4. 预测与置信区间

##### `predict()` 函数高级用法
- **置信区间类型**：
  - `interval = "confidence"`: 均值的置信区间
  - `interval = "prediction"`: 个体预测区间
- **置信水平**：通过`level`参数控制

##### 预测精度评估
- **均方误差(MSE)**：`mean(residuals(model)^2)`
- **均方根误差(RMSE)**：`sqrt(MSE)`
- **平均绝对误差(MAE)**：`mean(abs(residuals(model)))`

#### 5. 模型比较和选择

##### 模型拟合度指标
- **AIC (Akaike Information Criterion)**：
  - AIC = -2log(L) + 2k
  - 越小越好
  - 平衡拟合度和复杂度
- **BIC (Bayesian Information Criterion)**：
  - BIC = -2log(L) + k*log(n)
  - 对复杂度惩罚更严格

##### 模型验证方法
- **交叉验证**：留一法、k折交叉验证
- **训练-测试分割**：随机分割数据集
- **引导法(Bootstrap)**：重复抽样验证

### 课后练习

**题目**：某湿地生态系统水质与鸟类多样性关系研究数据：
```r
wetland_study <- data.frame(
  site = paste0("W", 1:20),
  water_clarity = c(2.1, 3.5, 1.8, 4.2, 2.9, 3.8, 1.5, 4.5, 2.3, 3.1,
                   4.0, 2.7, 3.3, 1.9, 4.1, 2.5, 3.6, 2.0, 4.3, 2.8),
  bird_diversity = c(1.2, 1.8, 1.0, 2.1, 1.5, 1.9, 0.9, 2.3, 1.3, 1.6,
                    2.0, 1.4, 1.7, 1.1, 2.2, 1.3, 1.8, 1.2, 2.4, 1.5),
  ph_value = c(7.2, 7.8, 6.9, 8.1, 7.5, 7.9, 6.8, 8.2, 7.3, 7.6,
              8.0, 7.4, 7.7, 7.0, 8.1, 7.3, 7.8, 7.1, 8.3, 7.5)
)
```

请完成以下分析（使用相关分析、线性回归等本课内容）：

1. **相关分析**：
   - 计算水体透明度与鸟类多样性的皮尔逊相关系数
   - 进行相关性显著性检验
   - 计算所有变量间的相关矩阵

2. **回归建模**：
   - 建立鸟类多样性对水体透明度的简单线性回归模型
   - 解释回归系数的生态学意义
   - 报告模型的R²和p值

3. **可视化分析**：
   - 绘制水体透明度与鸟类多样性的散点图
   - 添加回归线和回归方程
   - 创建变量间关系的散点图矩阵

4. **模型诊断**：
   - 进行残差分析，检查模型假设
   - 绘制残差诊断图
   - 检验残差的正态性

5. **预测应用**：
   - 预测透明度为3.0和4.0时的鸟类多样性
   - 计算预测的置信区间
   - 讨论预测结果的可靠性

6. **结果解释**：
   - 从生态学角度解释水质与鸟类多样性的关系
   - 讨论该模型在湿地管理中的应用价值
   - 指出研究的局限性和改进方向

7. **扩展分析**：
   - 探索pH值与其他变量的关系
   - 比较不同相关方法（Pearson vs Spearman）的结果
   - 识别可能的异常值及其对结果的影响