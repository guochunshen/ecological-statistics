## 第20课：混合效应模型

### 生态学背景
在生态学研究中，数据往往具有层次结构或存在分组效应。例如，在多年多地点的生态监测中，同一地点的重复测量之间存在相关性；在嵌套设计的实验中，同一处理组内的观测值可能更相似；在空间生态学研究中，邻近样点的数据可能存在空间自相关。传统的线性模型假设观测值独立，无法处理这种层次数据结构。混合效应模型通过引入随机效应，既能处理数据的非独立性，又能区分固定效应和随机变异，为复杂生态数据提供了强有力的分析工具。

### 演示数据
```r
# 生态学中的层次数据示例
library(lme4)  # 混合效应模型包
library(nlme)  # 另一个混合效应模型包
set.seed(123)

# 1. 多地点多年份森林生长监测数据
forest_growth <- data.frame(
  site_id = rep(paste0("Site_", 1:12), each = 20),
  year = rep(2015:2019, times = 48),
  plot_id = rep(paste0("Plot_", 1:48), each = 5),
  # 固定效应变量
  temperature = rnorm(240, 15, 3),
  rainfall = rnorm(240, 800, 150),
  # 随机效应：不同地点有不同的基线生长率
  site_effect = rep(rnorm(12, 0, 2), each = 20),
  plot_effect = rep(rnorm(48, 0, 1), each = 5),
  # 响应变量：树高增长（cm/year）
  height_growth = 25 + 0.8 * rnorm(240, 15, 3) + 0.01 * rnorm(240, 800, 150) +
                 rep(rnorm(12, 0, 2), each = 20) + rep(rnorm(48, 0, 1), each = 5) + 
                 rnorm(240, 0, 3)
)

# 2. 嵌套实验设计：不同森林管理方式对鸟类群落的影响
bird_community <- data.frame(
  forest_id = rep(paste0("F", 1:8), each = 45),
  management = rep(rep(c("自然", "选择性", "皆伐"), each = 15), times = 8),
  plot_id = paste0("P", 1:360),
  year_since_treatment = rep(rep(c(1, 2, 3, 4, 5), times = 3), times = 72),
  # 响应变量受到森林水平和管理方式的影响
  species_richness = rep(rep(c(15, 12, 8), each = 15), times = 8) + 
                    rep(rnorm(8, 0, 2), each = 45) + 
                    rep(rep(rnorm(24, 0, 1), each = 15), times = 3) +
                    rnorm(360, 0, 2)
)
```

### 课堂演示过程

#### 1. 线性混合效应模型基础
```r
# 创建简化的重复测量数据
set.seed(123)
plant_growth <- data.frame(
  plant_id = rep(paste0("Plant_", 1:20), each = 4),
  treatment = rep(c("Control", "Fertilized"), each = 40),
  time = rep(c(1, 2, 3, 4), times = 20),
  # 每个植株有不同的基线生长率（随机截距）
  plant_intercept = rep(rnorm(20, 0, 2), each = 4),
  height = 10 + 2 * rep(c(0, 1), each = 40) + 3 * rep(c(1, 2, 3, 4), times = 20) +
          rep(rnorm(20, 0, 2), each = 4) + rnorm(80, 0, 1.5)
)

# 1. 传统线性模型（错误方法）
wrong_model <- lm(height ~ treatment + time, data = plant_growth)
summary(wrong_model)

# 2. 随机截距模型
library(lme4)
random_intercept_model <- lmer(height ~ treatment + time + (1|plant_id), 
                              data = plant_growth)
summary(random_intercept_model)

# 3. 模型比较
# 似然比检验
library(lmerTest)  # 为lmer提供p值
random_intercept_model_test <- lmer(height ~ treatment + time + (1|plant_id), 
                                   data = plant_growth, REML = FALSE)
fixed_only_model <- lm(height ~ treatment + time, data = plant_growth)

# 比较AIC
AIC(random_intercept_model_test, fixed_only_model)

# 4. 随机效应的重要性
# 类内相关系数(ICC)
VarCorr(random_intercept_model)
var_between <- as.numeric(VarCorr(random_intercept_model)$plant_id[1])
var_within <- attr(VarCorr(random_intercept_model), "sc")^2
icc <- var_between / (var_between + var_within)
print(paste("类内相关系数:", round(icc, 3)))
```

#### 2. 随机斜率模型
```r
# 创建个体差异更明显的数据
set.seed(123)
individual_response <- data.frame(
  individual_id = rep(paste0("ID_", 1:15), each = 6),
  dose = rep(c(0, 1, 2, 3, 4, 5), times = 15),
  # 每个个体对剂量有不同的反应（随机斜率）
  individual_slope = rep(rnorm(15, 0, 0.5), each = 6),
  response = 5 + 2 * rep(c(0, 1, 2, 3, 4, 5), times = 15) + 
            rep(rnorm(15, 0, 1), each = 6) +  # 随机截距
            rep(c(0, 1, 2, 3, 4, 5), times = 15) * rep(rnorm(15, 0, 0.5), each = 6) + # 随机斜率
            rnorm(90, 0, 0.8)
)

# 1. 随机截距模型
model1 <- lmer(response ~ dose + (1|individual_id), data = individual_response)

# 2. 随机截距和斜率模型
model2 <- lmer(response ~ dose + (dose|individual_id), data = individual_response)

# 3. 模型比较
anova(model1, model2)
AIC(model1, model2)

# 4. 查看随机效应
ranef(model2)
coef(model2)  # 每个个体的系数

# 5. 可视化随机效应
library(ggplot2)
individual_coefs <- coef(model2)$individual_id
individual_coefs$individual_id <- rownames(individual_coefs)

ggplot(individual_response, aes(x = dose, y = response)) +
  geom_point() +
  geom_smooth(aes(group = individual_id), method = "lm", se = FALSE, alpha = 0.5) +
  geom_smooth(method = "lm", color = "red", size = 2) +
  labs(title = "个体水平的回归线（灰色）vs 群体水平（红色）")
```

#### 3. 嵌套和交叉随机效应
```r
# 创建嵌套设计数据：学校 > 班级 > 学生
set.seed(123)
nested_data <- data.frame(
  school_id = rep(paste0("School_", 1:6), each = 60),
  class_id = rep(paste0("Class_", 1:18), each = 20),
  student_id = paste0("Student_", 1:360),
  treatment = rep(c("A", "B", "C"), times = 120),
  # 学校水平随机效应
  school_effect = rep(rnorm(6, 0, 3), each = 60),
  # 班级水平随机效应（嵌套在学校内）
  class_effect = rep(rnorm(18, 0, 2), each = 20),
  score = 75 + 2 * as.numeric(as.factor(rep(c("A", "B", "C"), times = 120))) +
         rep(rnorm(6, 0, 3), each = 60) + rep(rnorm(18, 0, 2), each = 20) + 
         rnorm(360, 0, 5)
)

# 1. 嵌套随机效应模型
nested_model <- lmer(score ~ treatment + (1|school_id/class_id), data = nested_data)
summary(nested_model)

# 2. 等价写法
nested_model2 <- lmer(score ~ treatment + (1|school_id) + (1|class_id), data = nested_data)

# 3. 创建交叉分类数据：教师 × 学科
crossed_data <- expand.grid(
  teacher_id = paste0("T", 1:12),
  subject_id = paste0("S", 1:8)
)
crossed_data$score <- 70 + rnorm(nrow(crossed_data), 0, 3) + # 随机误差
                     rep(rnorm(12, 0, 2), times = 8) +      # 教师随机效应
                     rep(rnorm(8, 0, 1.5), each = 12)       # 学科随机效应

# 交叉随机效应模型
crossed_model <- lmer(score ~ 1 + (1|teacher_id) + (1|subject_id), data = crossed_data)
summary(crossed_model)
```

#### 4. 广义线性混合效应模型(GLMM)
```r
# 创建二项数据：种子萌发试验
set.seed(123)
germination_experiment <- data.frame(
  batch_id = rep(paste0("Batch_", 1:10), each = 20),
  temperature = rep(rep(c(15, 20, 25, 30), each = 5), times = 10),
  seeds_total = 50,
  # 批次随机效应影响萌发概率
  batch_effect = rep(rnorm(10, 0, 0.3), each = 20),
  logit_p = -1 + 0.1 * rep(rep(c(15, 20, 25, 30), each = 5), times = 10) + 
           rep(rnorm(10, 0, 0.3), each = 20),
  seeds_germinated = rbinom(200, 50, plogis(-1 + 0.1 * rep(rep(c(15, 20, 25, 30), each = 5), times = 10) + 
                                          rep(rnorm(10, 0, 0.3), each = 20)))
)

# 1. 逻辑混合效应模型
glmm_model <- glmer(cbind(seeds_germinated, seeds_total - seeds_germinated) ~ 
                   temperature + (1|batch_id), 
                   data = germination_experiment, family = binomial)
summary(glmm_model)

# 2. 泊松混合效应模型示例
count_data <- data.frame(
  site_id = rep(paste0("Site_", 1:8), each = 15),
  habitat = rep(c("Forest", "Grassland", "Wetland"), times = 40),
  count = rpois(120, lambda = exp(1.5 + 0.5 * as.numeric(as.factor(rep(c("Forest", "Grassland", "Wetland"), times = 40))) + 
                                rep(rnorm(8, 0, 0.3), each = 15)))
)

poisson_glmm <- glmer(count ~ habitat + (1|site_id), 
                     data = count_data, family = poisson)
summary(poisson_glmm)
```

#### 5. 模型诊断和评估
```r
# 1. 残差分析
plot(random_intercept_model)

# 2. 随机效应的正态性检验
random_effects <- ranef(random_intercept_model)$plant_id[,1]
qqnorm(random_effects)
qqline(random_effects)
shapiro.test(random_effects)

# 3. 模型预测
# 群体水平预测（边际预测）
new_data <- data.frame(treatment = c("Control", "Fertilized"), time = 2.5)
marginal_pred <- predict(random_intercept_model, new_data, re.form = NA)

# 条件预测（包含随机效应）
conditional_pred <- predict(random_intercept_model, 
                          data.frame(treatment = "Control", time = 2.5, plant_id = "Plant_1"))

# 4. R²计算
library(MuMIn)
r_squared <- r.squaredGLMM(random_intercept_model)
print(r_squared)
# R²m: 边际R²（仅固定效应解释的变异）
# R²c: 条件R²（固定+随机效应解释的变异）
```

### R语言知识点详解

#### 1. 混合效应模型理论

##### 模型框架
- **数学表达式**：Y = Xβ + Zu + ε
  - Y：响应变量向量
  - X：固定效应设计矩阵
  - β：固定效应系数
  - Z：随机效应设计矩阵
  - u：随机效应（u ~ N(0, G)）
  - ε：残差（ε ~ N(0, R)）

##### 固定效应vs随机效应
- **固定效应**：
  - 感兴趣的主要解释变量
  - 水平有限且可重复
  - 系数有具体含义
- **随机效应**：
  - 引起观测值相关性的分组变量
  - 水平众多且可看作随机抽样
  - 主要关注方差而非具体值

#### 2. R包和函数

##### `lme4` 包
- **`lmer()`**：线性混合效应模型
- **`glmer()`**：广义线性混合效应模型
- **语法**：`lmer(y ~ fixed_effects + (random_effects|grouping_var), data)`
- **随机效应语法**：
  - `(1|group)`：随机截距
  - `(x|group)`：随机截距和斜率
  - `(x||group)`：不相关的随机截距和斜率
  - `(1|group1/group2)`：嵌套随机效应

##### `nlme` 包
- **`lme()`**：线性混合效应模型的替代
- **优势**：更灵活的协方差结构
- **劣势**：速度较慢，语法较复杂

#### 3. 随机效应结构选择

##### 模型选择策略
1. **从简单开始**：仅包含随机截距
2. **逐步复杂化**：添加随机斜率
3. **模型比较**：使用似然比检验和信息准则
4. **生物学合理性**：考虑生态学机制

##### 嵌套vs交叉设计
- **嵌套设计**：下级单位仅属于一个上级单位
  - 例：样点嵌套在站点内
  - 语法：`(1|site/plot)`
- **交叉设计**：每个水平的组合都存在
  - 例：每个老师都教多个科目
  - 语法：`(1|teacher) + (1|subject)`

#### 4. 模型诊断

##### 残差分析
- **条件残差**：考虑随机效应的残差
- **边际残差**：仅考虑固定效应的残差
- **标准化残差**：考虑方差结构的标准化

##### 随机效应诊断
- **正态性假设**：检查随机效应的正态性
- **方差组分估计**：评估随机效应的重要性
- **收敛性检查**：确保模型正确收敛

#### 5. 预测和推断

##### 预测类型
- **边际预测**：固定效应预测（群体平均）
- **条件预测**：包含随机效应的预测（个体特异）
- **新群组预测**：对新个体/群组的预测

##### 不确定性量化
- **参数bootstrap**：基于参数分布的不确定性
- **残差bootstrap**：基于残差重抽样的不确定性
- **贝叶斯方法**：后验分布的不确定性

#### 6. 高级主题

##### 协方差结构
- **独立结构**：默认假设
- **复合对称**：组内相关性恒定
- **AR(1)**：一阶自回归结构
- **指数衰减**：空间/时间距离相关

##### 非线性混合效应模型
- **`nlme()`函数**：非线性混合效应模型
- **生长曲线**：logistic、Gompertz等
- **药代动力学**：一室、二室模型等

### 课后练习

**题目1**：多年森林监测数据：
```r
forest_monitoring <- data.frame(
  site_id = rep(paste0("Site_", LETTERS[1:8]), each = 25),
  year = rep(2018:2022, times = 40),
  plot_id = rep(paste0("Plot_", 1:40), each = 5),
  elevation = rep(rnorm(8, 1500, 300), each = 25),
  annual_temp = rnorm(200, 12, 2),
  annual_precip = rnorm(200, 900, 150),
  biomass = 200 + 0.02 * rep(rnorm(8, 1500, 300), each = 25) + 
           1.5 * rnorm(200, 12, 2) + 0.05 * rnorm(200, 900, 150) +
           rep(rnorm(8, 0, 10), each = 25) + rep(rnorm(40, 0, 5), each = 5) + 
           rnorm(200, 0, 8)
)
```

**题目2**：种子萌发嵌套实验：
```r
germination_nested <- data.frame(
  species_id = rep(paste0("Species_", 1:4), each = 75),
  population_id = rep(paste0("Pop_", 1:12), each = 25),
  temperature = rep(c(15, 20, 25), times = 100),
  light_condition = rep(c("暗", "光"), times = 150),
  seeds_total = 100,
  germination_prob = plogis(-0.5 + 0.1 * rep(c(15, 20, 25), times = 100) + 
                           0.3 * as.numeric(rep(c("暗", "光"), times = 150) == "光") +
                           rep(rnorm(4, 0, 0.4), each = 75) + 
                           rep(rnorm(12, 0, 0.2), each = 25)),
  seeds_germinated = rbinom(300, 100, plogis(-0.5 + 0.1 * rep(c(15, 20, 25), times = 100) + 
                                            0.3 * as.numeric(rep(c("暗", "光"), times = 150) == "光") +
                                            rep(rnorm(4, 0, 0.4), each = 75) + 
                                            rep(rnorm(12, 0, 0.2), each = 25)))
)
```

请完成以下混合效应模型分析：

1. **线性混合效应模型**（使用题目1数据）：
   - 建立生物量的线性混合效应模型
   - 考虑站点和样地的随机效应
   - 比较不同随机效应结构的模型
   - 计算类内相关系数

2. **广义线性混合效应模型**（使用题目2数据）：
   - 建立萌发率的逻辑混合效应模型
   - 处理物种和种群的嵌套效应
   - 评估固定效应的显著性

3. **模型诊断与评估**：
   - 检查残差的正态性和同方差性
   - 验证随机效应的分布假设
   - 计算边际R²和条件R²

4. **预测与应用**：
   - 进行边际预测和条件预测
   - 量化预测的不确定性
   - 从生态学角度解释结果

5. **高级分析**：
   - 探索随机斜率的必要性
   - 比较不同协方差结构
   - 讨论混合效应模型的优势