
# 概率与统计基础

## 概率

## 随机变量与概率分布

### 统计学背景
概率和统计是生态学研究的数学基础。自然界中的生态现象具有随机性，如种子萌发率、动物存活率、物种出现频次等。理解随机变量和概率分布有助于我们建立合适的统计模型，正确解释生态学数据。

### 演示数据
```r
# 森林生态学调查数据示例
set.seed(123)

# 1. 离散数据
nest_success <- rbinom(100, size = 1, prob = 0.65)    # 100个巢穴的成功/失败记录
insect_count <- rpois(80, lambda = 8)                 # 80个样方的昆虫个体数
species_count <- rnbinom(60, size = 3, prob = 0.4)    # 60个样方的物种数（过度分散）

# 2. 连续数据  
tree_height <- rnorm(50, mean = 15, sd = 3)           # 50棵树的高度数据（正态）
tree_diameter <- rlnorm(50, meanlog = 2.5, sdlog = 0.7) # 50棵树的直径数据（对数正态）
biomass <- rgamma(40, shape = 4, rate = 0.8)          # 40个样方的生物量数据（伽马）

# 3. 比例数据
canopy_cover <- rbeta(30, shape1 = 3, shape2 = 2)     # 30个样方的冠层盖度
seed_germination <- rbeta(25, shape1 = 8, shape2 = 2) # 25批种子的萌发率
```

### 课堂演示过程

#### 1. 随机变量的概念
```r
# 什么是随机变量？
# 随机变量是随机现象结果的数值表示

# 创建一些生态学随机变量的例子
set.seed(123)

# 例子1：鸟类筑巢成功（二项分布）
# 假设每个巢穴成功概率为0.65
nest_trials <- 10
success_prob <- 0.65

# 模拟10个巢穴的结果
nest_results <- rbinom(nest_trials, size = 1, prob = success_prob)
print(paste("筑巢结果:", paste(nest_results, collapse = ", ")))
print(paste("成功率:", mean(nest_results)))

# 例子2：树木高度（正态分布）
tree_heights <- rnorm(20, mean = 15, sd = 3)
print("树木高度（米）:")
print(round(tree_heights, 1))
print(paste("平均高度:", round(mean(tree_heights), 2), "米"))
```

#### 2. 常见概率分布

##### 二项分布（Binomial Distribution）
```r
# 二项分布：n次独立试验中成功次数的分布
# 生态学应用：种子发芽、动物存活、物种出现等

# 参数：n（试验次数），p（成功概率）
n_seeds <- 20
germination_prob <- 0.75

# 模拟种子发芽实验
germinated_seeds <- rbinom(1000, size = n_seeds, prob = germination_prob)

# 计算理论均值和方差
theoretical_mean <- n_seeds * germination_prob
theoretical_var <- n_seeds * germination_prob * (1 - germination_prob)

print(paste("理论均值:", theoretical_mean))
print(paste("实际均值:", round(mean(germinated_seeds), 2)))
print(paste("理论方差:", theoretical_var))
print(paste("实际方差:", round(var(germinated_seeds), 2)))

# 可视化二项分布
hist(germinated_seeds, breaks = 30, 
     main = "种子发芽数量分布", 
     xlab = "发芽种子数", ylab = "频数",
     col = "lightblue")
abline(v = theoretical_mean, col = "red", lwd = 2, lty = 2)
```

##### 正态分布（Normal Distribution）
```r
# 正态分布：连续变量的经典分布
# 生态学应用：生物量、身长、环境因子等连续测量

# 参数：μ（均值），σ（标准差）
mean_height <- 12
sd_height <- 2.5

# 生成树高数据
tree_heights <- rnorm(200, mean = mean_height, sd = sd_height)

# 描述统计
print(paste("样本均值:", round(mean(tree_heights), 2)))
print(paste("样本标准差:", round(sd(tree_heights), 2)))

# 正态分布的特性
# 68-95-99.7规则
within_1sd <- sum(abs(tree_heights - mean(tree_heights)) <= sd(tree_heights))
within_2sd <- sum(abs(tree_heights - mean(tree_heights)) <= 2*sd(tree_heights))

print(paste("1个标准差内的比例:", round(within_1sd/200, 3)))
print(paste("2个标准差内的比例:", round(within_2sd/200, 3)))

# 可视化正态分布
hist(tree_heights, breaks = 20, freq = FALSE,
     main = "树木高度分布", 
     xlab = "高度(米)", ylab = "密度",
     col = "lightgreen")

# 添加理论正态曲线
x_vals <- seq(5, 20, 0.1)
y_vals <- dnorm(x_vals, mean = mean_height, sd = sd_height)
lines(x_vals, y_vals, col = "red", lwd = 2)
```

##### 泊松分布（Poisson Distribution）
```r
# 泊松分布：单位时间/空间内事件发生次数
# 生态学应用：物种个体数、疾病发生率等计数数据

# 参数：λ（平均发生率）
lambda_insects <- 6

# 模拟昆虫计数
insect_counts <- rpois(100, lambda = lambda_insects)

# 统计特性
print(paste("理论均值:", lambda_insects))
print(paste("实际均值:", round(mean(insect_counts), 2)))
print(paste("理论方差:", lambda_insects))
print(paste("实际方差:", round(var(insect_counts), 2)))

# 泊松分布的特点：均值 = 方差
print(paste("均值/方差比:", round(mean(insect_counts)/var(insect_counts), 3)))

# 可视化泊松分布
hist(insect_counts, breaks = max(insect_counts), 
     main = "昆虫个体数分布", 
     xlab = "个体数", ylab = "频数",
     col = "yellow")
```

##### 负二项分布（Negative Binomial Distribution）
```r
# 负二项分布：过度分散计数数据的分布
# 生态学应用：森林物种计数、病虫害发生次数等

# 参数：size（成功次数），prob（成功概率）
size_param <- 5
prob_param <- 0.3

# 模拟过度分散的物种计数数据
overdispersed_counts <- rnbinom(100, size = size_param, prob = prob_param)

# 统计特性
print(paste("理论均值:", size_param*(1-prob_param)/prob_param))
print(paste("实际均值:", round(mean(overdispersed_counts), 2)))
print(paste("理论方差:", size_param*(1-prob_param)/prob_param^2))
print(paste("实际方差:", round(var(overdispersed_counts), 2)))

# 与泊松分布比较
poisson_counts <- rpois(100, lambda = mean(overdispersed_counts))
print(paste("泊松方差:", round(var(poisson_counts), 2)))
print(paste("过度分散指数:", round(var(overdispersed_counts)/mean(overdispersed_counts), 2)))

# 可视化负二项分布
hist(overdispersed_counts, breaks = 20, 
     main = "过度分散的物种计数分布", 
     xlab = "个体数", ylab = "频数",
     col = "orange")
```

##### 对数正态分布（Lognormal Distribution）
```r
# 对数正态分布：右偏连续数据的分布
# 生态学应用：森林生物量、树木直径、种子重量等

# 参数：对数尺度上的均值和标准差
meanlog <- 2.5
sdlog <- 0.8

# 模拟树木直径数据
tree_diameters <- rlnorm(200, meanlog = meanlog, sdlog = sdlog)

# 描述统计
print(paste("样本均值:", round(mean(tree_diameters), 2)))
print(paste("样本标准差:", round(sd(tree_diameters), 2)))
print(paste("偏度:", round(moments::skewness(tree_diameters), 2)))

# 理论均值和方差
theoretical_mean <- exp(meanlog + sdlog^2/2)
theoretical_var <- (exp(sdlog^2) - 1) * exp(2*meanlog + sdlog^2)

print(paste("理论均值:", round(theoretical_mean, 2)))
print(paste("理论方差:", round(theoretical_var, 2)))

# 可视化对数正态分布
hist(tree_diameters, breaks = 30, freq = FALSE,
     main = "树木直径分布（对数正态）", 
     xlab = "直径(cm)", ylab = "密度",
     col = "lightblue")

# 添加理论对数正态曲线
x_vals <- seq(0, max(tree_diameters), 0.1)
y_vals <- dlnorm(x_vals, meanlog = meanlog, sdlog = sdlog)
lines(x_vals, y_vals, col = "red", lwd = 2)
```

#### 3. R中的概率分布函数
```r
# R中每个分布都有4个函数：
# d*(): 概率密度/质量函数
# p*(): 累积分布函数
# q*(): 分位数函数
# r*(): 随机数生成

# 以正态分布为例
mu <- 15
sigma <- 3

# 1. 概率密度函数 dnorm()
x <- 15
density_at_15 <- dnorm(x, mean = mu, sd = sigma)
print(paste("在x=15处的密度:", round(density_at_15, 4)))

# 2. 累积分布函数 pnorm()
prob_less_than_18 <- pnorm(18, mean = mu, sd = sigma)
print(paste("P(X < 18):", round(prob_less_than_18, 3)))

# 3. 分位数函数 qnorm()
percentile_95 <- qnorm(0.95, mean = mu, sd = sigma)
print(paste("95%分位数:", round(percentile_95, 2)))

# 4. 随机数生成 rnorm()
random_values <- rnorm(10, mean = mu, sd = sigma)
print("10个随机值:")
print(round(random_values, 2))
```

#### 4. 分布的选择与拟合
```r
# 如何为生态数据选择合适的分布？

# 创建不同类型的生态数据
set.seed(456)

# 计数数据（泊松分布）
species_counts <- rpois(50, lambda = 12)

# 连续数据（正态分布）
leaf_lengths <- rnorm(50, mean = 8, sd = 1.5)

# 比例数据（贝塔分布或logit变换）
cover_percentages <- rbeta(50, shape1 = 3, shape2 = 2) * 100

# 检验正态性
shapiro_test <- shapiro.test(leaf_lengths)
print(paste("Shapiro-Wilk检验p值:", round(shapiro_test$p.value, 4)))

# QQ图检验正态性
qqnorm(leaf_lengths, main = "叶长正态性检验")
qqline(leaf_lengths, col = "red")

# 直方图 vs 理论分布比较
par(mfrow = c(2, 2))

# 泊松分布拟合
hist(species_counts, breaks = 15, freq = FALSE, 
     main = "物种数量分布", col = "lightblue")
x_pois <- 0:max(species_counts)
y_pois <- dpois(x_pois, lambda = mean(species_counts))
points(x_pois, y_pois, col = "red", pch = 19)

# 正态分布拟合
hist(leaf_lengths, breaks = 15, freq = FALSE,
     main = "叶长分布", col = "lightgreen")
x_norm <- seq(min(leaf_lengths), max(leaf_lengths), 0.1)
y_norm <- dnorm(x_norm, mean = mean(leaf_lengths), sd = sd(leaf_lengths))
lines(x_norm, y_norm, col = "red", lwd = 2)

par(mfrow = c(1, 1))
```

### R语言知识点详解

#### 1. 随机变量基础概念

##### 离散随机变量
- **定义**：取值为可数个的随机变量
- **生态学例子**：
  - 巢穴中雏鸟数量
  - 样方中物种个数
  - 一天内观察到的动物次数
- **常用分布**：二项分布、泊松分布、几何分布

##### 连续随机变量
- **定义**：取值在连续区间内的随机变量
- **生态学例子**：
  - 动物体重
  - 树木高度
  - 环境温度
- **常用分布**：正态分布、对数正态分布、伽马分布

#### 2. 重要概率分布详解

##### 二项分布 B(n, p)
- **参数**：
  - n：独立试验次数
  - p：每次试验成功概率
- **性质**：
  - E(X) = np
  - Var(X) = np(1-p)
- **R函数**：
  - `dbinom(x, size, prob)`：概率质量函数
  - `pbinom(q, size, prob)`：累积分布函数
  - `qbinom(p, size, prob)`：分位数函数
  - `rbinom(n, size, prob)`：随机数生成

##### 正态分布 N(μ, σ²)
- **参数**：
  - μ：均值
  - σ²：方差
- **性质**：
  - 对称分布
  - 68-95-99.7规则
  - 中心极限定理的基础
- **R函数**：
  - `dnorm(x, mean, sd)`：概率密度函数
  - `pnorm(q, mean, sd)`：累积分布函数
  - `qnorm(p, mean, sd)`：分位数函数
  - `rnorm(n, mean, sd)`：随机数生成

##### 泊松分布 Poisson(λ)
- **参数**：
  - λ：平均发生率
- **性质**：
  - E(X) = Var(X) = λ
  - 适用于稀有事件计数
- **R函数**：
  - `dpois(x, lambda)`：概率质量函数
  - `ppois(q, lambda)`：累积分布函数
  - `qpois(p, lambda)`：分位数函数
  - `rpois(n, lambda)`：随机数生成

##### 负二项分布 Negative Binomial(r, p)
- **参数**：
  - r：成功次数
  - p：成功概率
- **性质**：
  - E(X) = r(1-p)/p
  - Var(X) = r(1-p)/p²
  - 适用于过度分散的计数数据（森林物种计数常见）
- **R函数**：
  - `dnbinom(x, size, prob)`：概率质量函数
  - `pnbinom(q, size, prob)`：累积分布函数
  - `qnbinom(p, size, prob)`：分位数函数
  - `rnbinom(n, size, prob)`：随机数生成

##### 对数正态分布 Lognormal(μ, σ)
- **参数**：
  - μ：对数尺度上的均值
  - σ：对数尺度上的标准差
- **性质**：
  - 右偏分布，适用于森林生物量、树木直径等
  - 如果 Y ~ N(μ, σ²)，则 X = exp(Y) ~ Lognormal(μ, σ)
- **R函数**：
  - `dlnorm(x, meanlog, sdlog)`：概率密度函数
  - `plnorm(q, meanlog, sdlog)`：累积分布函数
  - `qlnorm(p, meanlog, sdlog)`：分位数函数
  - `rlnorm(n, meanlog, sdlog)`：随机数生成

##### 伽马分布 Gamma(α, β)
- **参数**：
  - α：形状参数
  - β：速率参数
- **性质**：
  - 适用于正值连续数据
  - 指数分布和卡方分布的特例
- **R函数**：
  - `dgamma(x, shape, rate)`：概率密度函数
  - `pgamma(q, shape, rate)`：累积分布函数
  - `qgamma(p, shape, rate)`：分位数函数
  - `rgamma(n, shape, rate)`：随机数生成

##### 贝塔分布 Beta(α, β)
- **参数**：
  - α：形状参数1
  - β：形状参数2
- **性质**：
  - 定义在[0,1]区间
  - 适用于比例、概率数据
- **R函数**：
  - `dbeta(x, shape1, shape2)`：概率密度函数
  - `pbeta(q, shape1, shape2)`：累积分布函数
  - `qbeta(p, shape1, shape2)`：分位数函数
  - `rbeta(n, shape1, shape2)`：随机数生成

#### 3. 分布检验方法

##### Shapiro-Wilk正态性检验
- **函数**：`shapiro.test(x)`
- **假设**：
  - H₀：数据来自正态分布
  - H₁：数据不来自正态分布
- **判断标准**：p < 0.05拒绝正态性假设

##### Q-Q图（Quantile-Quantile Plot）
- **函数**：`qqnorm(x)`, `qqline(x)`
- **原理**：比较样本分位数与理论分位数
- **判断**：点越接近直线，越符合正态分布

#### 4. 生态学中的分布选择指南

##### 计数数据
- **泊松分布**：个体数、物种数等（均值≈方差）
- **负二项分布**：过度分散的计数数据（方差>均值，森林物种计数常见）
- **二项分布**：成功/失败类型数据（固定试验次数）
- **零膨胀分布**：零值过多的计数数据（需要专门包如pscl）

##### 连续数据
- **正态分布**：生物量、长度等对称分布数据
- **对数正态分布**：右偏分布数据（森林生物量、树木直径、种子重量）
- **伽马分布**：正值连续数据（存活时间、生长速率）
- **威布尔分布**：生存分析、寿命分布（需要专门包）

##### 比例数据
- **贝塔分布**：0-1之间的比例数据（盖度、频率）
- **logit变换**：将比例转换为正态分布

##### 森林生态学特殊考虑
- **空间自相关**：森林数据常存在空间依赖性
- **层次结构**：样地-树木-个体的嵌套结构
- **混合分布**：异质森林环境可能产生多峰分布
- **截断数据**：调查中的最小测量阈值影响

### 课后练习

**题目**：某森林生态系统调查收集了以下数据：
```r
# 50个样方的鸟类物种数
bird_species <- c(5, 7, 8, 6, 9, 8, 7, 6, 8, 7, 6, 9, 8, 7, 6,
                  8, 9, 7, 6, 8, 7, 9, 8, 6, 7, 8, 9, 6, 7, 8,
                  9, 8, 7, 6, 9, 8, 7, 6, 8, 9, 7, 8, 6, 9, 8,
                  7, 6, 8, 9, 7)

# 30个植物个体的叶片长度（cm）
leaf_length <- c(12.3, 14.1, 13.8, 15.2, 12.9, 14.7, 13.5, 14.9, 13.1, 15.1,
                 14.3, 13.7, 14.8, 13.2, 14.5, 13.9, 14.2, 13.4, 15.0, 13.6,
                 14.4, 13.8, 14.6, 13.3, 14.1, 13.7, 14.9, 13.5, 14.3, 13.9)

# 100次种子萌发试验的成功次数（每次试验20粒种子）
germination_success <- c(16, 15, 18, 17, 14, 16, 15, 17, 16, 18, 
                         15, 16, 17, 15, 16, 18, 16, 17, 15, 16,
                         17, 16, 15, 18, 16, 17, 15, 16, 18, 17,
                         16, 15, 17, 16, 18, 15, 16, 17, 16, 18,
                         17, 16, 15, 18, 16, 17, 15, 16, 17, 18,
                         16, 15, 17, 16, 18, 15, 16, 17, 16, 18,
                         17, 16, 15, 17, 16, 18, 15, 16, 17, 16,
                         18, 17, 16, 15, 17, 16, 18, 15, 16, 17,
                         16, 18, 17, 16, 15, 17, 16, 18, 15, 16,
                         17, 16, 18, 17, 16, 15, 17, 16, 18, 15)

# 新增森林生态数据：
# 40棵树木的直径（cm）
tree_diameter <- c(12.3, 15.8, 22.1, 18.5, 14.2, 25.6, 19.8, 16.7, 28.3, 21.4,
                   13.9, 17.2, 24.8, 20.1, 15.3, 26.9, 18.7, 23.5, 16.8, 27.4,
                   14.7, 19.2, 22.8, 17.6, 29.1, 20.9, 15.8, 24.3, 18.2, 26.7,
                   13.5, 16.9, 21.7, 19.3, 25.4, 17.8, 23.9, 15.1, 27.8, 20.5)

# 30个样方的林下植物盖度（%）
understory_cover <- c(35, 28, 42, 19, 53, 37, 24, 46, 31, 58,
                      22, 39, 27, 44, 33, 49, 26, 41, 36, 51,
                      29, 45, 38, 23, 47, 32, 56, 25, 43, 34)

# 25个样方的枯落物厚度（cm）  
litter_depth <- c(2.3, 3.8, 1.9, 4.2, 2.7, 3.5, 2.1, 4.8, 3.2, 2.9,
                  4.1, 2.5, 3.7, 2.8, 4.5, 3.1, 2.4, 4.3, 3.6, 2.6,
                  4.0, 3.3, 2.2, 4.4, 3.4)
```

请完成（使用概率分布理论和R函数）：
1. **描述统计**：计算所有数据的均值、方差、范围（使用已学的统计函数）
2. **分布识别**：根据数据特征判断每组数据可能服从的分布类型
3. **正态性检验**：对叶片长度、树木直径、枯落物厚度数据进行Shapiro-Wilk检验
4. **分布拟合**：
   - 为鸟类物种数拟合泊松分布和负二项分布，比较拟合优度
   - 为萌发成功次数拟合二项分布，估计萌发概率
   - 为树木直径拟合正态分布和对数正态分布，比较哪种更合适
   - 为林下植物盖度拟合贝塔分布
5. **可视化**：绘制每组数据的直方图，并叠加理论分布曲线
6. **概率计算**：
   - 计算观察到5种以下鸟类的概率
   - 计算树木直径超过25cm的概率
   - 计算林下植物盖度低于30%的概率
   - 计算萌发成功数超过17的概率
7. **生态解释**：解释每种分布在森林生态学中的具体应用意义
8. **分布比较**：对于过度分散的计数数据，比较泊松分布和负二项分布的适用性
