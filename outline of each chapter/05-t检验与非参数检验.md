
## 第15课：t检验与非参数检验

### 统计学背景
t检验是最常用的假设检验方法之一，专门用于处理小样本情况下的均值比较问题。然而，t检验基于正态分布假设，当数据不满足正态性假设时，我们需要使用非参数检验方法。在生态学研究中，很多数据并不符合正态分布（如物种丰度、个体计数等），因此掌握非参数检验方法同样重要。

### 演示数据
```r
# 生态学t检验与非参数检验示例数据
set.seed(123)

# 正态分布数据（适合t检验）
normal_group1 <- rnorm(20, mean = 15, sd = 3)    # 植物高度组1
normal_group2 <- rnorm(20, mean = 18, sd = 3)    # 植物高度组2

# 偏斜分布数据（适合非参数检验）
skewed_before <- rexp(15, rate = 1/10)           # 指数分布：治疗前
skewed_after <- rexp(15, rate = 1/15)            # 治疗后

# 配对数据
before_treatment <- c(12, 15, 18, 14, 16, 13, 17, 19, 11, 20)
after_treatment <- c(18, 20, 22, 19, 21, 18, 23, 25, 16, 26)
```

### 课堂演示过程

#### 1. t检验的类型和应用

##### 单样本t检验
```r
# 单样本t检验：检验总体均值是否等于某个特定值
print("=== 单样本t检验 ===")

# 例子：检验某地区树木平均高度是否为16米
tree_heights <- rnorm(25, mean = 15.2, sd = 2.8)
hypothesized_mean <- 16

# 1. 检验数据正态性（t检验的前提）
shapiro_test <- shapiro.test(tree_heights)
print(paste("Shapiro-Wilk正态性检验 p值:", round(shapiro_test$p.value, 4)))

if (shapiro_test$p.value > 0.05) {
  print("数据符合正态分布假设，可以使用t检验")
} else {
  print("数据不符合正态分布假设，建议使用非参数检验")
}

# 2. 进行单样本t检验
one_sample_result <- t.test(tree_heights, mu = hypothesized_mean)

print("\n单样本t检验结果:")
print(paste("样本均值:", round(mean(tree_heights), 2)))
print(paste("假设均值:", hypothesized_mean))
print(paste("t统计量:", round(one_sample_result$statistic, 3)))
print(paste("自由度:", one_sample_result$parameter))
print(paste("p值:", round(one_sample_result$p.value, 4)))
print(paste("95%置信区间: [", round(one_sample_result$conf.int[1], 2), 
            ", ", round(one_sample_result$conf.int[2], 2), "]"))

# 3. 手动计算验证
manual_t <- (mean(tree_heights) - hypothesized_mean) / 
           (sd(tree_heights) / sqrt(length(tree_heights)))
print(paste("手动计算t统计量:", round(manual_t, 3)))
```

##### 配对样本t检验
```r
print("\n=== 配对样本t检验 ===")

# 例子：施肥前后植物生长比较
set.seed(456)
before_fertilizer <- rnorm(12, mean = 25, sd = 4)
# 施肥效果：平均增长3±1.5cm
growth_effect <- rnorm(12, mean = 3, sd = 1.5)
after_fertilizer <- before_fertilizer + growth_effect

# 1. 计算差值
differences <- after_fertilizer - before_fertilizer

print("施肥前后植物高度比较:")
print(paste("施肥前平均高度:", round(mean(before_fertilizer), 2)))
print(paste("施肥后平均高度:", round(mean(after_fertilizer), 2)))
print(paste("平均增长:", round(mean(differences), 2)))

# 2. 检验差值的正态性
diff_shapiro <- shapiro.test(differences)
print(paste("差值正态性检验 p值:", round(diff_shapiro$p.value, 4)))

# 3. 配对t检验
paired_result <- t.test(after_fertilizer, before_fertilizer, paired = TRUE)

print("\n配对t检验结果:")
print(paste("t统计量:", round(paired_result$statistic, 3)))
print(paste("自由度:", paired_result$parameter))
print(paste("p值:", round(paired_result$p.value, 4)))

# 4. 效应大小（Cohen's d for paired samples）
cohens_d_paired <- mean(differences) / sd(differences)
print(paste("Cohen's d:", round(cohens_d_paired, 3)))

# 5. 与独立样本比较（错误的分析方法）
wrong_test <- t.test(after_fertilizer, before_fertilizer, paired = FALSE)
print("\n错误的独立样本分析:")
print(paste("独立样本t检验 p值:", round(wrong_test$p.value, 4)))
print("注意：配对数据使用独立样本检验会损失统计效力!")
```

##### 独立样本t检验
```r
print("\n=== 独立样本t检验 ===")

# 例子：比较两种土壤改良剂的效果
set.seed(789)
soil_A <- rnorm(18, mean = 22, sd = 4.5)    # 改良剂A
soil_B <- rnorm(20, mean = 26, sd = 5.2)    # 改良剂B

print("两种土壤改良剂效果比较:")
print(paste("改良剂A平均效果:", round(mean(soil_A), 2)))
print(paste("改良剂B平均效果:", round(mean(soil_B), 2)))

# 1. 检验方差齐性（Levene检验）
# 使用car包的leveneTest，这里用简单的F检验代替
var_test <- var.test(soil_A, soil_B)
print(paste("方差齐性检验 p值:", round(var_test$p.value, 4)))

if (var_test$p.value > 0.05) {
  print("方差齐性假设成立，使用等方差t检验")
  equal_var <- TRUE
} else {
  print("方差不齐，使用Welch t检验")
  equal_var <- FALSE
}

# 2. 进行独立样本t检验
independent_result <- t.test(soil_A, soil_B, var.equal = equal_var)

print("\n独立样本t检验结果:")
print(paste("t统计量:", round(independent_result$statistic, 3)))
print(paste("自由度:", round(independent_result$parameter, 1)))
print(paste("p值:", round(independent_result$p.value, 4)))

# 3. 效应大小（Cohen's d for independent samples）
if (equal_var) {
  pooled_sd <- sqrt(((length(soil_A)-1)*var(soil_A) + (length(soil_B)-1)*var(soil_B)) /
                   (length(soil_A) + length(soil_B) - 2))
} else {
  # Hedges' g调整
  pooled_sd <- sqrt((var(soil_A) + var(soil_B)) / 2)
}

cohens_d_independent <- (mean(soil_B) - mean(soil_A)) / pooled_sd
print(paste("Cohen's d:", round(cohens_d_independent, 3)))

# 效应大小解释
if (abs(cohens_d_independent) < 0.2) {
  effect_size <- "很小"
} else if (abs(cohens_d_independent) < 0.5) {
  effect_size <- "小"
} else if (abs(cohens_d_independent) < 0.8) {
  effect_size <- "中等"
} else {
  effect_size <- "大"
}
print(paste("效应大小解释:", effect_size))
```

#### 2. t检验的前提假设检验

```r
print("=== t检验假设检验 ===")

# 生成违反假设的数据示例
set.seed(999)

# 1. 正态性检验
print("1. 正态性检验:")

# 正态分布数据
normal_data <- rnorm(30, mean = 10, sd = 2)
normal_test <- shapiro.test(normal_data)
print(paste("正态数据 Shapiro-Wilk p值:", round(normal_test$p.value, 4)))

# 偏斜分布数据
skewed_data <- rexp(30, rate = 0.5)  # 指数分布
skewed_test <- shapiro.test(skewed_data)
print(paste("偏斜数据 Shapiro-Wilk p值:", round(skewed_test$p.value, 4)))

# 2. 方差齐性检验
print("\n2. 方差齐性检验:")

group1 <- rnorm(25, mean = 15, sd = 2)    # 方差 = 4
group2 <- rnorm(25, mean = 17, sd = 5)    # 方差 = 25

variance_test <- var.test(group1, group2)
print(paste("F检验 p值:", round(variance_test$p.value, 4)))
print(paste("方差比:", round(var(group2)/var(group1), 2)))

# 3. 独立性假设（通过设计保证，无法统计检验）
print("\n3. 独立性假设:")
print("独立性假设需要通过实验设计保证，无法用统计方法直接检验")
print("常见违反独立性的情况：")
print("- 重复测量同一个体")
print("- 空间或时间上的相关性")
print("- 层次结构数据（如学校内的学生）")

# 4. QQ图检验正态性
par(mfrow = c(1, 2))

# 正态数据的QQ图
qqnorm(normal_data, main = "正态数据QQ图")
qqline(normal_data, col = "red")

# 偏斜数据的QQ图
qqnorm(skewed_data, main = "偏斜数据QQ图")
qqline(skewed_data, col = "red")

par(mfrow = c(1, 1))
```

#### 3. 非参数检验方法

##### Wilcoxon检验（Mann-Whitney U检验）
```r
print("=== 非参数检验 ===")

# 1. Wilcoxon秩和检验（独立样本的非参数替代）
print("1. Wilcoxon秩和检验（Mann-Whitney U检验）:")

# 创建偏斜分布数据
set.seed(321)
group_A <- rexp(15, rate = 1/8)    # 指数分布，均值约8
group_B <- rexp(18, rate = 1/12)   # 指数分布，均值约12

print("偏斜分布数据比较:")
print(paste("组A中位数:", round(median(group_A), 2)))
print(paste("组B中位数:", round(median(group_B), 2)))

# 正态性检验
print(paste("组A正态性检验 p值:", round(shapiro.test(group_A)$p.value, 4)))
print(paste("组B正态性检验 p值:", round(shapiro.test(group_B)$p.value, 4)))

# 由于数据不符合正态分布，使用Wilcoxon秩和检验
wilcox_independent <- wilcox.test(group_A, group_B)
print("\nWilcoxon秩和检验结果:")
print(paste("W统计量:", wilcox_independent$statistic))
print(paste("p值:", round(wilcox_independent$p.value, 4)))

# 对比t检验结果（不合适但用于比较）
t_test_wrong <- t.test(group_A, group_B)
print(paste("不合适的t检验 p值:", round(t_test_wrong$p.value, 4)))
```

##### Wilcoxon符号秩检验（配对样本）
```r
# 2. Wilcoxon符号秩检验（配对样本的非参数替代）
print("\n2. Wilcoxon符号秩检验:")

# 创建配对的偏斜数据
set.seed(654)
before_values <- rexp(12, rate = 1/10)
# 处理效果不是加法效应，而是比例效应
after_values <- before_values * runif(12, min = 1.2, max = 2.0)

differences_nonparam <- after_values - before_values

print("配对数据（偏斜分布）:")
print(paste("处理前中位数:", round(median(before_values), 2)))
print(paste("处理后中位数:", round(median(after_values), 2)))
print(paste("差值正态性检验 p值:", round(shapiro.test(differences_nonparam)$p.value, 4)))

# Wilcoxon符号秩检验
wilcox_paired <- wilcox.test(after_values, before_values, paired = TRUE)
print("\nWilcoxon符号秩检验结果:")
print(paste("V统计量:", wilcox_paired$statistic))
print(paste("p值:", round(wilcox_paired$p.value, 4)))

# 对比配对t检验
paired_t_wrong <- t.test(after_values, before_values, paired = TRUE)
print(paste("不合适的配对t检验 p值:", round(paired_t_wrong$p.value, 4)))
```

##### 单样本Wilcoxon检验
```r
# 3. 单样本Wilcoxon检验（符号检验的改进版）
print("\n3. 单样本Wilcoxon检验:")

# 检验中位数是否等于某个值
sample_data <- rexp(20, rate = 1/15)  # 指数分布，理论中位数约10.4

hypothesized_median <- 10

print(paste("样本中位数:", round(median(sample_data), 2)))
print(paste("假设中位数:", hypothesized_median))
print(paste("正态性检验 p值:", round(shapiro.test(sample_data)$p.value, 4)))

# 单样本Wilcoxon检验
one_sample_wilcox <- wilcox.test(sample_data, mu = hypothesized_median)
print("\n单样本Wilcoxon检验结果:")
print(paste("V统计量:", one_sample_wilcox$statistic))
print(paste("p值:", round(one_sample_wilcox$p.value, 4)))
```

#### 4. 检验方法选择指南

```r
print("=== 检验方法选择指南 ===")

# 创建决策函数
choose_test_method <- function(data1, data2 = NULL, paired = FALSE) {
  
  print("=== 检验方法选择分析 ===")
  
  if (is.null(data2)) {
    # 单样本情况
    print("数据类型: 单样本")
    
    # 正态性检验
    normality_test <- shapiro.test(data1)
    print(paste("正态性检验 p值:", round(normality_test$p.value, 4)))
    
    if (normality_test$p.value > 0.05) {
      print("推荐方法: 单样本t检验")
      print("原因: 数据符合正态分布假设")
    } else {
      print("推荐方法: 单样本Wilcoxon检验")
      print("原因: 数据不符合正态分布假设")
    }
    
  } else {
    # 两样本情况
    if (paired) {
      print("数据类型: 配对样本")
      
      differences <- data2 - data1
      normality_test <- shapiro.test(differences)
      print(paste("差值正态性检验 p值:", round(normality_test$p.value, 4)))
      
      if (normality_test$p.value > 0.05) {
        print("推荐方法: 配对样本t检验")
        print("原因: 差值符合正态分布假设")
      } else {
        print("推荐方法: Wilcoxon符号秩检验")
        print("原因: 差值不符合正态分布假设")
      }
      
    } else {
      print("数据类型: 独立样本")
      
      # 正态性检验
      norm_test1 <- shapiro.test(data1)
      norm_test2 <- shapiro.test(data2)
      
      print(paste("组1正态性检验 p值:", round(norm_test1$p.value, 4)))
      print(paste("组2正态性检验 p值:", round(norm_test2$p.value, 4)))
      
      if (norm_test1$p.value > 0.05 && norm_test2$p.value > 0.05) {
        # 方差齐性检验
        var_test <- var.test(data1, data2)
        print(paste("方差齐性检验 p值:", round(var_test$p.value, 4)))
        
        if (var_test$p.value > 0.05) {
          print("推荐方法: 等方差双样本t检验")
          print("原因: 数据符合正态分布假设且方差齐性")
        } else {
          print("推荐方法: Welch t检验（不等方差t检验）")
          print("原因: 数据符合正态分布假设但方差不齐")
        }
      } else {
        print("推荐方法: Wilcoxon秩和检验（Mann-Whitney U检验）")
        print("原因: 至少有一组数据不符合正态分布假设")
      }
    }
  }
}

# 测试决策函数
print("测试1: 正态分布独立样本")
set.seed(111)
normal_sample1 <- rnorm(20, 15, 3)
normal_sample2 <- rnorm(20, 18, 3)
choose_test_method(normal_sample1, normal_sample2)

print("\n" %+% "="%+%rep("=", 40) %+% "\n")

print("测试2: 偏斜分布独立样本")
set.seed(222)
skewed_sample1 <- rexp(20, 1/10)
skewed_sample2 <- rexp(20, 1/15)
choose_test_method(skewed_sample1, skewed_sample2)
```

#### 5. 实际生态学案例分析

```r
print("=== 实际生态学案例 ===")

# 案例1：入侵植物对土壤微生物多样性的影响
set.seed(777)

print("案例1: 入侵植物对土壤微生物多样性的影响")

# 模拟微生物多样性指数（通常右偏）
# 使用Gamma分布模拟
control_sites <- rgamma(25, shape = 3, rate = 0.2)    # 对照样地
invaded_sites <- rgamma(25, shape = 2, rate = 0.2)    # 入侵样地

print(paste("对照样地平均多样性:", round(mean(control_sites), 2)))
print(paste("入侵样地平均多样性:", round(mean(invaded_sites), 2)))

# 数据分布检查
par(mfrow = c(2, 2))
hist(control_sites, main = "对照样地分布", breaks = 10)
hist(invaded_sites, main = "入侵样地分布", breaks = 10)
qqnorm(control_sites, main = "对照样地QQ图")
qqline(control_sites, col = "red")
qqnorm(invaded_sites, main = "入侵样地QQ图")  
qqline(invaded_sites, col = "red")
par(mfrow = c(1, 1))

# 正态性检验
control_shapiro <- shapiro.test(control_sites)
invaded_shapiro <- shapiro.test(invaded_sites)

print(paste("对照样地正态性 p值:", round(control_shapiro$p.value, 4)))
print(paste("入侵样地正态性 p值:", round(invaded_shapiro$p.value, 4)))

# 根据正态性检验结果选择方法
if (control_shapiro$p.value > 0.05 && invaded_shapiro$p.value > 0.05) {
  # 使用t检验
  case1_result <- t.test(control_sites, invaded_sites)
  method_used <- "独立样本t检验"
} else {
  # 使用非参数检验
  case1_result <- wilcox.test(control_sites, invaded_sites)
  method_used <- "Wilcoxon秩和检验"
}

print(paste("使用方法:", method_used))
print(paste("p值:", round(case1_result$p.value, 4)))

# 案例2：施肥处理的配对实验
print("\n案例2: 施肥处理对植物生长的配对实验")

set.seed(888)

# 10个实验地块，每个地块分为两部分：对照和施肥
# 模拟配对数据，施肥效果存在但数据有偏斜
plot_baseline <- runif(10, 10, 20)  # 地块基础差异
control_growth <- plot_baseline + rlnorm(10, 0, 0.3)  # 对照组（对数正态）
fertilizer_effect <- rlnorm(10, log(1.3), 0.2)       # 施肥效应
fertilized_growth <- plot_baseline * fertilizer_effect + rnorm(10, 0, 1)

print(paste("施肥前中位数:", round(median(control_growth), 2)))
print(paste("施肥后中位数:", round(median(fertilized_growth), 2)))

# 配对差值分析
growth_diff <- fertilized_growth - control_growth
diff_shapiro <- shapiro.test(growth_diff)

print(paste("差值正态性 p值:", round(diff_shapiro$p.value, 4)))

# 选择合适的配对检验
if (diff_shapiro$p.value > 0.05) {
  case2_result <- t.test(fertilized_growth, control_growth, paired = TRUE)
  method_used2 <- "配对t检验"
} else {
  case2_result <- wilcox.test(fertilized_growth, control_growth, paired = TRUE)
  method_used2 <- "Wilcoxon符号秩检验"
}

print(paste("使用方法:", method_used2))
print(paste("p值:", round(case2_result$p.value, 4)))

# 效应大小（对于非参数，可以用r = Z/√n）
print("\n效应大小估计:")
if (method_used2 == "配对t检验") {
  cohens_d <- mean(growth_diff) / sd(growth_diff)
  print(paste("Cohen's d:", round(cohens_d, 3)))
} else {
  # 对于Wilcoxon检验，计算效应大小r
  n <- length(growth_diff)
  # 这里简化计算，实际中需要从检验统计量计算Z值
  print("非参数检验效应大小计算需要额外的统计量")
  print("可以报告中位数差异和四分位距作为效应大小的描述")
}
```

### R语言知识点详解

#### 1. t检验函数详解

##### `t.test()` 函数参数
- **基本语法**：
  - 单样本：`t.test(x, mu = 0)`
  - 独立样本：`t.test(x, y, var.equal = TRUE)`
  - 配对样本：`t.test(x, y, paired = TRUE)`

##### 重要参数说明
- **`alternative`**：指定备择假设
  - `"two.sided"`：双侧检验（默认）
  - `"less"`：左侧检验
  - `"greater"`：右侧检验
- **`var.equal`**：是否假设方差相等
  - `TRUE`：使用合并方差估计（Student's t）
  - `FALSE`：使用Welch t检验（默认）
- **`conf.level`**：置信水平（默认0.95）

#### 2. 非参数检验函数

##### `wilcox.test()` 函数
- **独立样本**：`wilcox.test(x, y)`
- **配对样本**：`wilcox.test(x, y, paired = TRUE)`
- **单样本**：`wilcox.test(x, mu = 0)`

##### 非参数检验优势
- **不需要正态分布假设**
- **对异常值稳健**
- **适用于有序分类数据**
- **样本量要求较低**

#### 3. 假设检验前提检验

##### 正态性检验
- **`shapiro.test()`**：Shapiro-Wilk检验
  - 适用于小样本（n < 5000）
  - H₀：数据来自正态分布
- **`ks.test()`**：Kolmogorov-Smirnov检验
- **图形方法**：QQ图、直方图

##### 方差齐性检验
- **`var.test()`**：F检验（仅适用于正态数据）
- **Levene检验**：`leveneTest()`（car包）
- **Bartlett检验**：`bartlett.test()`

#### 4. 效应大小计算

##### Cohen's d
- **配对样本**：d = mean(差值) / sd(差值)
- **独立样本**：d = (mean₁ - mean₂) / 合并标准差
- **解释标准**：
  - 小效应：|d| = 0.2
  - 中效应：|d| = 0.5
  - 大效应：|d| = 0.8

#### 5. 检验选择决策树

```
样本类型？
├── 单样本
│   ├── 正态分布？→ 单样本t检验
│   └── 非正态分布？→ 单样本Wilcoxon检验
├── 配对样本
│   ├── 差值正态分布？→ 配对t检验
│   └── 差值非正态？→ Wilcoxon符号秩检验
└── 独立样本
    ├── 两组都正态？
    │   ├── 方差齐性？→ 等方差t检验
    │   └── 方差不齐？→ Welch t检验
    └── 至少一组非正态？→ Wilcoxon秩和检验
```

### 课后练习

**题目**：某湿地修复项目效果评估数据：

```r
# 修复前后水质指标（配对数据）
before_restoration <- c(3.2, 4.1, 2.8, 5.2, 3.9, 4.5, 3.6, 4.8, 3.1, 4.2,
                       3.8, 4.6, 3.4, 4.1, 3.7, 2.9, 4.3, 3.5, 4.7, 3.3)

after_restoration <- c(4.8, 5.2, 4.1, 6.1, 4.9, 5.8, 4.7, 6.2, 4.3, 5.1,
                      4.9, 5.7, 4.5, 5.3, 4.8, 4.2, 5.6, 4.6, 5.9, 4.4)

# 修复区与对照区植被覆盖度（独立样本）
restored_coverage <- c(68, 72, 65, 78, 71, 75, 69, 74, 70, 73, 67, 76, 72, 68, 75,
                      71, 74, 69, 77, 70, 73, 68, 75, 72, 74)

control_coverage <- c(45, 48, 42, 52, 46, 49, 43, 51, 47, 50, 44, 53, 48, 45, 51,
                     47, 49, 44, 52, 46, 50, 43, 52, 47, 49)

# 鸟类物种丰富度数据（可能偏斜）
species_richness <- c(8, 15, 12, 25, 18, 22, 14, 28, 16, 21, 13, 26, 19, 23, 17,
                     27, 20, 24, 15, 29, 18, 22, 16, 25, 19, 23, 14, 27, 20, 24)

expected_richness <- 18  # 期望的物种丰富度
```

请完成（使用t检验和非参数检验方法，结合之前学过的所有统计知识）：

1. **数据探索性分析**：
   - 计算各组数据的描述统计量（均值、中位数、标准差等）
   - 绘制直方图和QQ图检查数据分布
   - 进行正态性检验（Shapiro-Wilk检验）

2. **配对样本分析**：
   - 分析修复前后水质指标的变化
   - 选择合适的检验方法（配对t检验或Wilcoxon符号秩检验）
   - 计算置信区间和效应大小

3. **独立样本分析**：
   - 比较修复区与对照区的植被覆盖度
   - 检验方差齐性，选择合适的t检验类型
   - 如果假设不满足，使用非参数检验替代

4. **单样本检验**：
   - 检验鸟类物种丰富度是否显著不同于期望值18
   - 根据数据分布选择合适的检验方法
   - 计算并解释置信区间

5. **检验方法比较**：
   - 对同一组数据同时进行参数和非参数检验
   - 比较两种方法的结果和结论
   - 讨论何时应该选择非参数检验

6. **效应大小与实际意义**：
   - 计算各检验的效应大小
   - 区分统计显著性和实际意义
   - 从生态学角度解释结果的实际意义

7. **检验假设验证**：
   - 系统性检查所有t检验的前提假设
   - 对违反假设的数据提出改进建议
   - 评估非参数检验的适用性
