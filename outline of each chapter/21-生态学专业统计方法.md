## 第21课：生态学专业统计方法

### 生态学背景
生态学作为一门研究生物与环境相互作用的科学，在长期发展过程中形成了许多专门的统计分析方法。这些方法专门用于处理生态数据的特殊性质，如物种群落的复杂结构、环境梯度的非线性响应、生物多样性的量化等。传统统计方法往往无法充分捕捉生态系统的复杂性，而生态学专业统计方法为理解生态模式、过程和机制提供了强有力的工具。本课将介绍生态学中最重要和常用的专业统计方法。

### 演示数据
```r
# 生态学专业统计方法演示数据
library(vegan)    # 生态学统计包
library(cluster)  # 聚类分析
library(MASS)     # 多元统计
set.seed(123)

# 1. 物种群落数据矩阵（样地×物种）
species_matrix <- matrix(
  rpois(150, lambda = 3), # 15个样地，10个物种的丰度数据
  nrow = 15, ncol = 10,
  dimnames = list(
    paste0("Site_", 1:15),
    paste0("Species_", LETTERS[1:10])
  )
)

# 2. 环境数据矩阵
env_matrix <- data.frame(
  site_id = paste0("Site_", 1:15),
  elevation = rnorm(15, 1500, 300),
  temperature = rnorm(15, 15, 3),
  rainfall = rnorm(15, 800, 150),
  soil_ph = rnorm(15, 6.5, 0.5),
  soil_nitrogen = rnorm(15, 25, 8)
)
rownames(env_matrix) <- paste0("Site_", 1:15)

# 3. 功能性状数据
trait_matrix <- data.frame(
  species = paste0("Species_", LETTERS[1:10]),
  leaf_area = rnorm(10, 50, 15),        # 叶面积 (cm²)
  seed_mass = rlnorm(10, 2, 0.8),       # 种子质量 (mg)
  plant_height = rnorm(10, 100, 30),    # 植物高度 (cm)
  sla = rnorm(10, 200, 50),            # 比叶面积 (cm²/g)
  wood_density = rnorm(10, 0.6, 0.15)  # 木材密度 (g/cm³)
)
rownames(trait_matrix) <- paste0("Species_", LETTERS[1:10])
```

### 课堂演示过程

#### 1. 生物多样性指数计算
```r
library(vegan)

# 创建简化的物种群落数据
community_data <- matrix(
  c(12, 8, 5, 2, 1, 0, 3, 7, 9, 4,
    8, 15, 3, 6, 2, 1, 0, 4, 8, 5,
    5, 12, 18, 8, 4, 2, 1, 0, 6, 3,
    2, 6, 12, 20, 9, 5, 3, 1, 0, 2,
    0, 3, 8, 15, 25, 8, 6, 4, 2, 1),
  nrow = 5, byrow = TRUE,
  dimnames = list(
    paste0("Site_", 1:5),
    paste0("Sp_", LETTERS[1:10])
  )
)

# 1. α多样性指数
# Shannon多样性指数
shannon_div <- diversity(community_data, index = "shannon")
print("Shannon多样性指数:")
print(shannon_div)

# Simpson多样性指数
simpson_div <- diversity(community_data, index = "simpson")
print("Simpson多样性指数:")
print(simpson_div)

# 物种丰富度
species_richness <- specnumber(community_data)
print("物种丰富度:")
print(species_richness)

# Pielou均匀度指数
pielou_evenness <- shannon_div / log(species_richness)
print("Pielou均匀度:")
print(pielou_evenness)

# 2. 稀疏化曲线（Rarefaction）
rarecurve(community_data, step = 1, sample = min(rowSums(community_data)),
          main = "物种累积曲线", xlab = "个体数", ylab = "物种数")

# 3. β多样性
# Bray-Curtis不相似性
bray_dist <- vegdist(community_data, method = "bray")
print("Bray-Curtis距离矩阵:")
print(as.matrix(bray_dist)[1:3, 1:3])

# Jaccard不相似性（基于出现/缺失）
community_binary <- decostand(community_data, method = "pa")
jaccard_dist <- vegdist(community_binary, method = "jaccard")

# 4. 多样性的分解
# 加法分解：γ = α + β
alpha_mean <- mean(specnumber(community_data))
gamma_total <- specnumber(colSums(community_data))
beta_additive <- gamma_total - alpha_mean

print(paste("平均α多样性:", round(alpha_mean, 2)))
print(paste("γ多样性:", gamma_total))
print(paste("β多样性(加法):", round(beta_additive, 2)))
```

#### 2. 排序分析（Ordination）
```r
# 1. 主成分分析（PCA）- 适用于线性响应
pca_result <- prcomp(community_data, scale = TRUE)
summary(pca_result)

# PCA双标图
biplot(pca_result, main = "PCA双标图")

# 2. 对应分析（CA）- 适用于梯度较长的数据
ca_result <- cca(community_data)
summary(ca_result)

# 绘制CA排序图
plot(ca_result, type = "text", main = "对应分析排序图")

# 3. 非度量多维标度（NMDS）- 适用于非线性响应
nmds_result <- metaMDS(community_data, distance = "bray", k = 2)
print(paste("NMDS应力值:", round(nmds_result$stress, 3)))

# 绘制NMDS图
plot(nmds_result, type = "text", main = "NMDS排序图")

# 应力值解释
if(nmds_result$stress < 0.1) {
  print("优秀的排序结果")
} else if(nmds_result$stress < 0.2) {
  print("良好的排序结果")
} else {
  print("可接受的排序结果")
}

# 4. 冗余分析（RDA）- 约束排序
# 创建环境变量
env_vars <- data.frame(
  temp = rnorm(5, 15, 3),
  moisture = rnorm(5, 70, 10),
  ph = rnorm(5, 6.5, 0.5)
)
rownames(env_vars) <- rownames(community_data)

rda_result <- rda(community_data ~ temp + moisture + ph, data = env_vars)
summary(rda_result)

# RDA双标图
plot(rda_result, type = "text", main = "冗余分析图")

# 置换检验
anova(rda_result, permutations = 999)
```

#### 3. 聚类分析
```r
# 1. 层次聚类
# 基于Bray-Curtis距离的聚类
hclust_result <- hclust(bray_dist, method = "average")

# 绘制系统树
plot(hclust_result, main = "样地聚类系统树", 
     xlab = "样地", ylab = "距离")

# 确定聚类数量
# 使用轮廓分析
library(cluster)
sil_width <- numeric(4)
for(k in 2:5) {
  clusters <- cutree(hclust_result, k = k)
  sil <- silhouette(clusters, bray_dist)
  sil_width[k-1] <- mean(sil[,3])
}

plot(2:5, sil_width, type = "b", 
     xlab = "聚类数", ylab = "平均轮廓宽度",
     main = "最优聚类数确定")

# 选择最优聚类数
optimal_k <- which.max(sil_width) + 1
clusters <- cutree(hclust_result, k = optimal_k)
print(paste("最优聚类数:", optimal_k))

# 在系统树上标记聚类
plot(hclust_result, main = "样地聚类系统树")
rect.hclust(hclust_result, k = optimal_k, border = "red")

# 2. 指示种分析
library(indicspecies)
# 计算指示种
indicator_species <- multipatt(community_data, clusters, 
                              func = "r.g", control = how(nperm=999))
summary(indicator_species, indvalcomp = TRUE)
```

#### 4. 群落结构分析
```r
# 1. 种-面积关系
# 物种累积曲线
specaccum_result <- specaccum(community_data, method = "random")
plot(specaccum_result, ci.type = "poly", col = "blue", lwd = 2,
     main = "物种累积曲线", xlab = "样地数", ylab = "累积物种数")

# 拟合种-面积关系模型
# 假设面积数据
area_data <- c(100, 200, 400, 800, 1600)  # m²
species_area_model <- lm(log(species_richness) ~ log(area_data))
summary(species_area_model)

# 2. 群落相似性分析
# Bray-Curtis相似性的影响因素
# 距离衰减关系
geographic_dist <- dist(env_vars[,1:2])  # 基于环境变量计算地理距离的代理
mantel_test <- mantel(bray_dist, geographic_dist, method = "pearson", 
                     permutations = 999)
print(mantel_test)

# 3. 功能多样性
# 计算功能性状距离
trait_data <- trait_matrix[1:10, 2:6]  # 选择数值性状
functional_dist <- dist(scale(trait_data))

# 功能多样性指数
library(FD)
# 准备数据：群落矩阵和性状矩阵必须匹配
community_subset <- community_data
traits_subset <- trait_data

# 计算功能多样性
functional_diversity <- dbFD(traits_subset, community_subset)
print("功能丰富度:")
print(functional_diversity$FRic)
print("功能均匀度:")
print(functional_diversity$FEve)
print("功能离散度:")
print(functional_diversity$FDiv)
```

#### 5. 环境梯度分析
```r
# 1. 梯度长度估算
# 使用去趋势对应分析（DCA）估算梯度长度
dca_result <- decorana(community_data)
print("DCA轴长度:")
print(dca_result$evals)

# 梯度长度解释
axis1_length <- dca_result$evals[1]
if(axis1_length < 3) {
  print("线性响应，推荐使用RDA")
} else {
  print("单峰响应，推荐使用CCA")
}

# 2. 典范对应分析（CCA）
cca_result <- cca(community_data ~ temp + moisture + ph, data = env_vars)
summary(cca_result)

# CCA三标图
plot(cca_result, type = "text", main = "典范对应分析")

# 环境变量的显著性检验
anova(cca_result, by = "terms", permutations = 999)

# 3. 变差分解
# 将环境变量分组
env_group1 <- env_vars[, 1:2]  # 气候变量
env_group2 <- env_vars[, 3, drop = FALSE]    # 土壤变量

# 变差分解
varpart_result <- varpart(community_data, env_group1, env_group2)
print(varpart_result)
plot(varpart_result, digits = 2, main = "变差分解")

# 4. 环境拟合和物种拟合
# 环境因子在排序空间的拟合
envfit_result <- envfit(nmds_result, env_vars, permutations = 999)
print(envfit_result)

# 在NMDS图上添加环境向量
plot(nmds_result, type = "text", main = "NMDS + 环境拟合")
plot(envfit_result, add = TRUE, col = "red")
```

### R语言知识点详解

#### 1. vegan包核心功能

##### 多样性指数函数
- **`diversity()`**：计算各种多样性指数
  - Shannon: H' = -∑(pi × ln(pi))
  - Simpson: D = ∑(pi²)
  - InvSimpson: 1/D
- **`specnumber()`**：计算物种丰富度
- **`evenness()`**：计算均匀度指数

##### 排序分析函数
- **`prcomp()`**：主成分分析
- **`cca()`**：对应分析和典范对应分析
- **`rda()`**：主成分分析和冗余分析  
- **`metaMDS()`**：非度量多维标度
- **`decorana()`**：去趋势对应分析

##### 距离和相似性
- **`vegdist()`**：生态学距离计算
  - Bray-Curtis: 2C/(A+B)
  - Jaccard: C/(A+B-C)
  - Euclidean: 标准欧氏距离
- **`decostand()`**：数据标准化
  - "total": 相对丰度
  - "pa": 出现/缺失
  - "hellinger": Hellinger变换

#### 2. 排序方法选择指南

##### 梯度长度判断
- **短梯度 (< 3 SD)**：线性响应，使用RDA/PCA
- **长梯度 (> 4 SD)**：单峰响应，使用CCA/CA
- **中等梯度 (3-4 SD)**：两种方法都可以

##### 约束vs无约束排序
- **无约束排序**：探索性分析，寻找主要梯度
- **约束排序**：验证性分析，检验环境假设

#### 3. 聚类分析要点

##### 距离选择
- **Bray-Curtis**：丰度数据，对零值不敏感
- **Jaccard**：出现/缺失数据
- **Euclidean**：环境数据，连续变量

##### 聚类方法
- **Average linkage**：平均连接，较稳定
- **Complete linkage**：最大距离连接
- **Ward**：最小方差方法，紧凑聚类

#### 4. 功能多样性概念

##### 功能多样性指数
- **功能丰富度(FRic)**：性状空间体积
- **功能均匀度(FEve)**：性状空间内分布均匀性
- **功能离散度(FDiv)**：离群性状的贡献
- **功能分化(FDis)**：到重心的平均距离

##### 性状选择原则
- **生态相关性**：选择影响生态功能的关键性状
- **独立性**：避免高度相关的冗余性状
- **可测量性**：选择可靠测量的性状

#### 5. 环境梯度分析

##### 变差分解
- **纯环境效应**：仅由环境变量解释的变异
- **纯空间效应**：仅由空间结构解释的变异
- **共同效应**：环境和空间共同解释的变异
- **残差**：未解释的变异

##### Mantel检验
- **原理**：比较两个距离矩阵的相关性
- **应用**：检验群落相似性与环境/空间距离的关系
- **偏Mantel检验**：控制第三个矩阵的影响

### 课后练习

**题目**：某山地森林群落研究数据：
```r
# 群落数据（12个样地，20个物种）
mountain_community <- matrix(
  rpois(240, lambda = 2), 
  nrow = 12, ncol = 20,
  dimnames = list(
    paste0("Site_", sprintf("%02d", 1:12)),
    paste0("Species_", sprintf("%02d", 1:20))
  )
)

# 环境数据
mountain_env <- data.frame(
  elevation = seq(1000, 2200, by = 100) + rnorm(12, 0, 50),
  slope = rnorm(12, 25, 8),
  aspect = sample(c("N", "S", "E", "W"), 12, replace = TRUE),
  soil_depth = rnorm(12, 40, 10),
  canopy_cover = rnorm(12, 70, 15),
  soil_ph = rnorm(12, 6.2, 0.6)
)
rownames(mountain_env) <- rownames(mountain_community)

# 功能性状数据
species_traits <- data.frame(
  leaf_thickness = rnorm(20, 0.3, 0.1),
  seed_mass = rlnorm(20, 1, 0.5),
  max_height = rlnorm(20, 3, 0.8),
  wood_density = rnorm(20, 0.5, 0.15),
  leaf_nitrogen = rnorm(20, 2.5, 0.5)
)
rownames(species_traits) <- colnames(mountain_community)
```

请完成以下生态学专业统计分析：

1. **生物多样性分析**：
   - 计算各样地的α多样性指数（Shannon、Simpson、丰富度、均匀度）
   - 绘制稀疏化曲线
   - 计算β多样性和进行多样性分解

2. **排序分析**：
   - 进行DCA分析估算梯度长度
   - 根据梯度长度选择合适的排序方法
   - 进行无约束排序和约束排序
   - 进行环境拟合分析

3. **聚类分析**：
   - 进行层次聚类分析
   - 确定最优聚类数
   - 进行指示种分析

4. **功能多样性分析**：
   - 计算功能多样性指数
   - 分析功能多样性与环境梯度的关系
   - 比较物种多样性和功能多样性的模式

5. **环境梯度分析**：
   - 进行变差分解分析
   - 检验距离-衰减关系
   - 分析群落结构与环境因子的关系

6. **综合解释**：
   - 从生态学角度解释所有分析结果
   - 讨论群落构建的主要驱动因子
   - 提出进一步研究的建议