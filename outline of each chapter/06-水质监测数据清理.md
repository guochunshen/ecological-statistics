
## 第6课：水质监测数据清理

### 生态学背景
在水质监测中，由于仪器故障、人为记录错误等原因，经常出现缺失值和异常值。数据清理是生态学数据分析的重要步骤，需要识别和处理这些问题数据。

### 演示数据
```r
# 湖泊水质监测数据（包含缺失值和异常值）
water_quality <- data.frame(
  site_id = c("湖心", "入水口", "出水口", "湖心", "入水口", "出水口"),
  date = c("2023-05-01", "2023-05-01", "2023-05-01", "2023-05-15", "2023-05-15", "2023-05-15"),
  pH = c(7.2, 6.8, NA, 7.5, 6.9, 7.1),
  temperature_C = c(18.5, 19.2, 20.1, 999, 19.8, 20.3),  # 999为仪器错误读数
  dissolved_oxygen = c(8.2, 7.5, 8.8, 8.1, NA, 8.4)
)
```

### 课堂演示过程
```r
# 1. 创建包含问题的水质数据
water_quality <- data.frame(
  site_id = c("湖心", "入水口", "出水口", "湖心", "入水口", "出水口"),
  date = c("2023-05-01", "2023-05-01", "2023-05-01", "2023-05-15", "2023-05-15", "2023-05-15"),
  pH = c(7.2, 6.8, NA, 7.5, 6.9, 7.1),
  temperature_C = c(18.5, 19.2, 20.1, 999, 19.8, 20.3),
  dissolved_oxygen = c(8.2, 7.5, 8.8, 8.1, NA, 8.4)
)

# 2. 查看原始数据
print(water_quality)
str(water_quality)

# 3. 检查缺失值
is.na(water_quality)  # 显示所有缺失值位置
sum(is.na(water_quality$pH))  # pH缺失值个数
sum(is.na(water_quality$dissolved_oxygen))  # 溶解氧缺失值个数

# 4. 识别异常值
summary(water_quality$temperature_C)  # 查看温度的统计摘要
water_quality$temperature_C > 50  # 找出不合理的高温值

# 5. 处理缺失值 - 用均值填补
ph_mean <- mean(water_quality$pH, na.rm = TRUE)  # 计算pH均值（忽略NA）
water_quality$pH[is.na(water_quality$pH)] <- ph_mean

# 6. 处理异常值 - 替换为NA
water_quality$temperature_C[water_quality$temperature_C > 50] <- NA

# 7. 查看清理后的数据
print(water_quality)

# 8. 删除包含NA的整行（如果需要）
clean_data <- na.omit(water_quality)
print(clean_data)

# 9. 计算清理后的统计量
mean(clean_data$temperature_C)
mean(clean_data$pH)
mean(clean_data$dissolved_oxygen)
```

### R语言知识点详解

#### 1. 缺失值（Missing Values）处理系统
##### 缺失值的概念
- **什么是NA**：Not Available的缩写，表示缺失或不可用的数据
- **NA的特点**：
  - 任何包含NA的运算结果都是NA
  - NA具有传染性：`1 + NA = NA`
  - NA不等于任何值，包括它自己：`NA == NA` 返回NA而不是TRUE

##### `is.na()` 函数
- **作用**：检测缺失值的位置
- **语法**：`is.na(x)`
- **返回值**：与输入同样结构的逻辑向量/矩阵，TRUE表示缺失
- **应用方式**：
  - 检查单个向量：`is.na(vector)`
  - 检查整个数据框：`is.na(data.frame)`
  - 统计缺失值数量：`sum(is.na(vector))`

##### `na.rm` 参数
- **作用**：在统计计算中移除缺失值
- **语法**：`function(x, na.rm = FALSE)`
- **适用函数**：`mean()`, `sum()`, `max()`, `min()`, `sd()`등
- **重要性**：不设置`na.rm = TRUE`时，有NA的计算结果都是NA
- **示例对比**：
  ```r
  x <- c(1, 2, NA, 4)
  mean(x)           # 返回 NA
  mean(x, na.rm = TRUE)  # 返回 2.33
  ```

##### `na.omit()` 函数
- **作用**：删除包含任何缺失值的完整行
- **语法**：`na.omit(x)`
- **返回值**：不含任何NA的数据框
- **注意事项**：
  - 可能导致大量数据丢失
  - 需要评估删除行对分析的影响
  - 适合缺失值较少且随机分布的情况

#### 2. 异常值（Outliers）识别与处理
##### 异常值的识别方法
- **统计方法**：使用`summary()`查看数据分布，识别明显不合理的值
- **业务逻辑**：基于专业知识判断，如温度999°C明显错误
- **可视化方法**：使用箱线图、散点图等发现异常值
- **统计阈值**：如超出3倍标准差的值

##### 异常值处理策略
1. **删除异常值**：适用于明显的录入错误
2. **替换为NA**：保留数据结构，标记为缺失
3. **替换为合理值**：用中位数、均值等替换
4. **保留但标记**：在分析中特殊处理

#### 3. 条件替换技术
##### 逻辑索引替换
- **语法**：`data[condition] <- new_value`
- **原理**：通过逻辑条件选择满足条件的元素进行替换
- **示例**：
  ```r
  # 将所有负值替换为0
  data[data < 0] <- 0
  
  # 将异常高值替换为NA
  data[data > threshold] <- NA
  ```

##### `which()` 函数
- **作用**：返回满足条件的元素位置索引
- **语法**：`which(condition)`
- **与直接逻辑索引的区别**：
  - 逻辑索引：返回TRUE/FALSE向量
  - `which()`：返回位置数字向量
- **应用**：当需要知道具体位置时使用

#### 4. 数据清理流程和最佳实践
##### 标准数据清理流程
1. **数据探索**：使用`str()`, `summary()`, `head()`, `tail()`了解数据
2. **缺失值检查**：使用`is.na()`, `sum(is.na())`统计缺失情况
3. **异常值识别**：结合统计和专业知识识别异常值
4. **清理决策**：选择合适的处理方法
5. **执行清理**：应用处理方法
6. **验证结果**：检查清理后的数据质量

##### 数据清理的注意事项
- **保留原始数据**：清理前备份原始数据
- **记录清理过程**：文档化所有清理步骤和决策理由
- **验证合理性**：确保清理后的数据符合业务逻辑
- **评估影响**：分析清理对后续分析的影响

##### 缺失值填补方法选择
- **均值填补**：适用于数值变量，数据接近正态分布
- **中位数填补**：适用于有偏斜的数值变量
- **众数填补**：适用于分类变量
- **前向/后向填补**：适用于时间序列数据
- **预测模型填补**：基于其他变量预测缺失值

### 课后练习
**题目**：某森林土壤调查数据：
```r
soil_data <- data.frame(
  plot = c("A1", "A2", "A3", "B1", "B2", "B3"),
  organic_matter = c(3.2, NA, 2.8, 3.5, 2.9, 3.1),
  nitrogen_mg = c(45, 52, -10, 48, 51, 49),  # -10为异常负值
  moisture = c(25.5, 28.2, 22.1, NA, 26.8, 24.9)
)
```

请完成（使用缺失值处理、条件判断、数据清理等已学内容）：
1. 检查每列的缺失值个数（使用is.na()和sum()函数）
2. 识别nitrogen_mg列中的异常值（使用逻辑判断和which()函数）
3. 用均值填补organic_matter的缺失值（使用mean()和na.rm参数）
4. 将nitrogen_mg中的异常值替换为NA（使用条件赋值）
5. 创建一个完全没有缺失值的干净数据集（使用na.omit()）
6. 计算清理后数据的各项平均值（使用mean()函数）
7. 对比清理前后数据的summary()结果
