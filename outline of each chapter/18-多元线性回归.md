## 第18课：多元线性回归

### 生态学背景
在现实的生态系统中，生物响应往往受到多个环境因子的同时影响。例如，植物的生长不仅受到温度的影响，还受到降水量、土壤养分、光照强度等多个因子的共同作用。单一变量的简单回归往往无法充分解释生态现象的复杂性。多元线性回归允许我们同时考虑多个预测变量，建立更现实、更准确的生态学预测模型，并量化各个环境因子的相对重要性。

### 演示数据
```r
# 某森林生态系统植物生产力影响因子研究
set.seed(123)
forest_productivity <- data.frame(
  plot_id = paste0("P", sprintf("%02d", 1:50)),
  # 响应变量：植物净初级生产力 (g/m²/year)
  npp = 800 + 15 * rnorm(50, 15, 3) + 8 * rnorm(50, 25, 5) + 
        12 * rnorm(50, 6.5, 0.5) - 3 * rnorm(50, 1200, 200) + rnorm(50, 0, 50),
  # 预测变量
  temperature = rnorm(50, 15, 3),          # 年平均温度 (°C)
  precipitation = rnorm(50, 1200, 200),    # 年降水量 (mm)
  soil_nitrogen = rnorm(50, 25, 5),        # 土壤氮含量 (mg/kg)
  soil_ph = rnorm(50, 6.5, 0.5),         # 土壤pH值
  elevation = rnorm(50, 1500, 300),        # 海拔 (m)
  canopy_cover = rnorm(50, 75, 15)         # 冠层覆盖度 (%)
)

# 确保数据在合理范围内
forest_productivity$npp[forest_productivity$npp < 400] <- 400
forest_productivity$canopy_cover[forest_productivity$canopy_cover > 100] <- 100
forest_productivity$canopy_cover[forest_productivity$canopy_cover < 30] <- 30
```

### 课堂演示过程

#### 1. 多元回归模型建立
```r
# 创建简化的示例数据
set.seed(123)
plant_data <- data.frame(
  biomass = 100 + 2*rnorm(30, 20, 3) + 1.5*rnorm(30, 800, 100) + 
            3*rnorm(30, 6.8, 0.4) + rnorm(30, 0, 8),
  temperature = rnorm(30, 20, 3),
  rainfall = rnorm(30, 800, 100), 
  soil_ph = rnorm(30, 6.8, 0.4)
)

# 1. 建立多元线性回归模型
full_model <- lm(biomass ~ temperature + rainfall + soil_ph, data = plant_data)
summary(full_model)

# 2. 查看模型系数
coef(full_model)

# 3. 检查各预测变量的显著性
summary(full_model)$coefficients

# 4. 模型整体显著性检验
anova(full_model)
```

#### 2. 相关性和多重共线性检查
```r
# 1. 预测变量间相关性矩阵
predictors <- plant_data[, c("temperature", "rainfall", "soil_ph")]
cor_matrix <- cor(predictors)
print(cor_matrix)

# 2. 相关性可视化
pairs(predictors, main = "预测变量间相关性")

# 3. 方差膨胀因子（VIF）检查多重共线性
# 安装和加载car包
# install.packages("car")
library(car)
vif(full_model)

# VIF解释：
# VIF < 5: 无严重多重共线性问题
# 5 ≤ VIF < 10: 中等多重共线性
# VIF ≥ 10: 严重多重共线性

# 4. 条件数检查
X <- model.matrix(full_model)[, -1]  # 移除截距列
condition_number <- kappa(cor(X))
print(paste("条件数:", round(condition_number, 2)))
```

#### 3. 模型选择与比较
```r
# 1. 向前选择法
null_model <- lm(biomass ~ 1, data = plant_data)
forward_model <- step(null_model, 
                     scope = list(lower = null_model, 
                                 upper = full_model),
                     direction = "forward")

# 2. 向后消除法
backward_model <- step(full_model, direction = "backward")

# 3. 双向选择法
both_model <- step(null_model, 
                  scope = list(lower = null_model, 
                              upper = full_model),
                  direction = "both")

# 4. 比较不同模型
AIC(full_model, forward_model, backward_model, both_model)
BIC(full_model, forward_model, backward_model, both_model)

# 5. 嵌套模型比较（F检验）
# 比较简化模型vs完整模型
reduced_model <- lm(biomass ~ temperature + soil_ph, data = plant_data)
anova(reduced_model, full_model)
```

#### 4. 模型诊断
```r
# 1. 残差分析
par(mfrow = c(2, 2))

# 残差vs拟合值
plot(fitted(full_model), residuals(full_model),
     xlab = "拟合值", ylab = "残差",
     main = "残差vs拟合值")
abline(h = 0, col = "red", lty = 2)

# Q-Q图
qqnorm(residuals(full_model), main = "残差Q-Q图")
qqline(residuals(full_model), col = "red")

# 标准化残差vs拟合值
plot(fitted(full_model), rstandard(full_model),
     xlab = "拟合值", ylab = "标准化残差", 
     main = "标准化残差vs拟合值")
abline(h = c(-2, 0, 2), col = c("red", "black", "red"), lty = c(2, 1, 2))

# Cook距离
plot(cooks.distance(full_model), type = "h",
     ylab = "Cook距离", main = "影响点分析")
abline(h = 4/(nrow(plant_data)-length(coef(full_model))), col = "red", lty = 2)

par(mfrow = c(1, 1))

# 2. 正态性检验
shapiro.test(residuals(full_model))

# 3. 同方差性检验（Breusch-Pagan检验）
library(lmtest)
bptest(full_model)

# 4. 独立性检验（Durbin-Watson检验）
dwtest(full_model)
```

#### 5. 预测和解释
```r
# 1. 模型预测
new_data <- data.frame(
  temperature = c(18, 22, 25),
  rainfall = c(750, 900, 1000),
  soil_ph = c(6.5, 7.0, 7.2)
)

# 点预测
predictions <- predict(full_model, new_data)
print(predictions)

# 置信区间和预测区间
conf_pred <- predict(full_model, new_data, interval = "confidence")
pred_intervals <- predict(full_model, new_data, interval = "prediction")

print("置信区间:")
print(conf_pred)
print("预测区间:")
print(pred_intervals)

# 2. 标准化系数（相对重要性）
# 标准化数据
standardized_data <- data.frame(scale(plant_data))
std_model <- lm(biomass ~ temperature + rainfall + soil_ph, 
                data = standardized_data)
std_coef <- coef(std_model)[-1]  # 移除截距
print("标准化系数:")
print(std_coef)

# 3. 偏相关系数
library(ppcor)
partial_cor <- pcor(plant_data[, c("biomass", "temperature", "rainfall", "soil_ph")])
print("偏相关系数:")
print(partial_cor$estimate[1, -1])
```

### R语言知识点详解

#### 1. 多元线性回归模型

##### 模型形式
- **数学表达式**：Y = β₀ + β₁X₁ + β₂X₂ + ... + βₚXₚ + ε
- **矩阵形式**：Y = Xβ + ε
- **假设条件**：
  - 线性关系：响应变量与预测变量呈线性关系
  - 独立性：观测值相互独立
  - 同方差性：残差方差恒定
  - 正态性：残差服从正态分布
  - 无多重共线性：预测变量间无强相关

##### 参数估计
- **最小二乘法**：β̂ = (X'X)⁻¹X'Y
- **系数解释**：
  - βᵢ表示在其他变量不变的情况下，Xᵢ增加一个单位时Y的变化量
  - β₀为截距，表示所有预测变量为0时Y的预期值

#### 2. 多重共线性问题

##### 多重共线性的后果
- **系数不稳定**：小样本变化导致系数大幅波动
- **标准误增大**：降低系数显著性
- **解释困难**：难以确定各变量的独立作用

##### 诊断方法
- **相关系数矩阵**：|r| > 0.8提示可能存在共线性
- **方差膨胀因子(VIF)**：
  - VIF = 1/(1-R²ᵢ)
  - VIF > 10表示严重共线性
  - VIF > 5需要关注
- **条件数(Condition Number)**：
  - κ > 30表示严重共线性

##### 处理方法
- **删除变量**：移除冗余的预测变量
- **主成分回归**：使用主成分作为预测变量
- **岭回归**：添加正则化项
- **合并变量**：创建综合指标

#### 3. 变量选择方法

##### 逐步回归法
- **向前选择**：从空模型开始逐步添加变量
- **向后消除**：从全模型开始逐步删除变量  
- **双向选择**：结合向前和向后选择

##### `step()` 函数详解
- **语法**：`step(object, scope, direction, k)`
- **参数说明**：
  - `scope`：变量选择范围
  - `direction`：选择方向("forward", "backward", "both")
  - `k`：惩罚系数，AIC=2，BIC=log(n)

##### 信息准则
- **AIC (Akaike Information Criterion)**：
  - 平衡拟合度和模型复杂度
  - AIC = -2log(L) + 2p
  - 越小越好
- **BIC (Bayesian Information Criterion)**：
  - 对复杂度惩罚更严格
  - BIC = -2log(L) + p*log(n)

#### 4. 模型诊断技术

##### 残差分析扩展
- **标准化残差**：rᵢ = eᵢ/√(MSE(1-hᵢᵢ))
- **学生化残差**：考虑删除第i个观测后的残差
- **杠杆值**：hᵢᵢ = x'ᵢ(X'X)⁻¹xᵢ
- **Cook距离**：Dᵢ = (r²ᵢ/(p+1)) * (hᵢᵢ/(1-hᵢᵢ))

##### 假设检验
- **正态性检验**：
  - Shapiro-Wilk检验：`shapiro.test()`
  - Anderson-Darling检验
  - Kolmogorov-Smirnov检验
- **同方差性检验**：
  - Breusch-Pagan检验：`bptest()`
  - White检验
  - 残差图目视检查
- **独立性检验**：
  - Durbin-Watson检验：`dwtest()`
  - Ljung-Box检验

#### 5. 模型解释与应用

##### 系数解释
- **原始系数**：实际单位的影响大小
- **标准化系数**：相对重要性比较
- **弹性系数**：百分比变化的影响

##### 预测评估
- **模型拟合度**：
  - R²：决定系数
  - 调整R²：考虑变量数量的修正
  - F统计量：模型整体显著性
- **预测精度**：
  - RMSE：均方根误差
  - MAE：平均绝对误差
  - MAPE：平均绝对百分比误差

##### 变量重要性
- **标准化回归系数**：β*ᵢ = βᵢ * (sₓᵢ/sᵧ)
- **偏相关系数**：控制其他变量后的相关性
- **增量R²**：单个变量的独特贡献

### 课后练习

**题目**：某草原生态系统植被生物量影响因子研究数据：
```r
grassland_study <- data.frame(
  site_id = paste0("G", 1:40),
  biomass = c(145, 178, 132, 198, 156, 189, 167, 143, 201, 174,
             188, 159, 176, 134, 192, 161, 183, 149, 196, 171,
             157, 185, 141, 203, 168, 179, 153, 187, 165, 194,
             172, 181, 147, 199, 163, 175, 139, 191, 169, 177),
  temperature = c(12.5, 15.2, 11.8, 16.1, 13.7, 15.8, 14.3, 12.1, 16.5, 14.9,
                 15.6, 13.4, 14.7, 11.9, 15.9, 13.8, 15.3, 12.6, 16.2, 14.5,
                 13.2, 15.4, 12.3, 16.7, 14.1, 14.8, 13.0, 15.7, 14.0, 16.0,
                 14.6, 15.1, 12.4, 16.3, 13.9, 14.7, 11.7, 15.8, 14.2, 14.9),
  precipitation = c(380, 450, 320, 510, 410, 480, 430, 350, 520, 460,
                   490, 400, 470, 330, 500, 420, 485, 370, 515, 445,
                   395, 475, 340, 525, 415, 465, 385, 495, 425, 505,
                   455, 485, 360, 518, 405, 470, 315, 500, 435, 475),
  soil_organic = c(2.1, 2.8, 1.9, 3.2, 2.4, 3.0, 2.6, 2.0, 3.4, 2.7,
                  3.1, 2.3, 2.9, 1.8, 3.3, 2.5, 3.0, 2.2, 3.2, 2.6,
                  2.4, 3.0, 2.0, 3.5, 2.5, 2.8, 2.3, 3.1, 2.6, 3.3,
                  2.7, 3.0, 2.1, 3.4, 2.4, 2.9, 1.7, 3.2, 2.6, 2.8),
  elevation = c(1150, 1380, 1020, 1450, 1250, 1420, 1320, 1080, 1480, 1350,
               1410, 1200, 1370, 1050, 1440, 1280, 1400, 1120, 1460, 1340,
               1230, 1390, 1090, 1490, 1300, 1360, 1180, 1430, 1270, 1470,
               1330, 1395, 1110, 1465, 1260, 1375, 1040, 1445, 1310, 1385)
)
```

请完成以下多元回归分析（使用多元线性回归方法）：

1. **探索性数据分析**：
   - 计算所有变量的描述性统计
   - 创建变量间的相关系数矩阵和散点图矩阵
   - 识别可能的异常值

2. **多元回归建模**：
   - 建立生物量对所有环境变量的完整多元回归模型
   - 解释各回归系数的生态学意义
   - 评估模型的整体显著性和拟合度

3. **多重共线性诊断**：
   - 计算各预测变量的方差膨胀因子(VIF)
   - 分析预测变量间的相关性
   - 判断是否存在多重共线性问题

4. **模型选择**：
   - 使用向前选择、向后消除和双向选择方法
   - 比较不同模型的AIC和BIC值
   - 选择最优模型并说明理由

5. **模型诊断**：
   - 绘制残差诊断图（残差vs拟合值、Q-Q图等）
   - 检验残差的正态性、同方差性和独立性
   - 识别异常值和高影响点

6. **模型解释与应用**：
   - 计算标准化回归系数，比较各变量的相对重要性
   - 进行模型预测，计算置信区间和预测区间
   - 从生态学角度解释模型结果

7. **结果报告**：
   - 撰写模型结果的统计报告
   - 讨论各环境因子对草原生物量的影响机制
   - 提出模型的应用价值和局限性

8. **扩展分析**：
   - 探索变量间可能的交互作用
   - 尝试非线性变换（如对数变换）
   - 比较简单回归与多元回归的预测效果